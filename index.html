<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Kartvaaler – VISNING (rollback stable v1)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    /* Warp-canvas legges i overlayPane og er klikk-gjennom (mobil-zoom fix) */
    .leaflet-overlay-pane canvas.leaflet-warp2d { position:absolute; inset:0; pointer-events:none; z-index: 450; }
    .leaflet-overlay-pane img.leaflet-image-layer { z-index: 440; }

    /* En liten statusindikator (kan fjernes) */
    .status { position: fixed; z-index: 1100; right: 10px; top: 10px; background: rgba(255,255,255,.92); padding: 6px 8px; border-radius: 8px; font: 12px/1.4 system-ui, sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,.12);} 
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status" class="status">Laster…</div>

  <script>
    // --- Fast konfig (samme som opprinnelig) ---
    const IMAGE_URL = 'Turkart.png';
    const WARP_CORNERS = {
      NW: [59.54593535667747, 10.765142440795898],
      NE: [59.539561484456776, 11.201162338256838],
      SE: [59.380786150970934, 11.190948486328127],
      SW: [59.387167906588274, 10.756945610046387]
    };

    const MAP_CENTER = [59.48, 10.98];
    const MAP_ZOOM = 11;

    const $status = document.getElementById('status');
    function setStatus(s){ $status.textContent = s; }

    // --- Kart ---
    const map = L.map('map', { zoomControl:true, attributionControl:true }).setView(MAP_CENTER, MAP_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' }).addTo(map);

    // --- Robust 2D warp‑lag (flat) ---
    class Warp2DLayer extends L.Layer{
      constructor(img){ super(); this._img = img; }
      onAdd(map){ this._map=map; this._c=L.DomUtil.create('canvas','leaflet-warp2d'); this._ctx=this._c.getContext('2d'); map.getPanes().overlayPane.appendChild(this._c); this._onMv=this._draw.bind(this); map.on('move zoom viewreset resize', this._onMv); this._resize(); this._draw(); }
      onRemove(map){ map.off('move zoom viewreset resize', this._onMv); this._c.remove(); }
      setCorners(c){ this._corners=c; this._draw(); }
      _resize(){ const s=this._map.getSize(); this._c.width=s.x; this._c.height=s.y; L.DomUtil.setPosition(this._c, L.point(0,0)); }
      _draw(){ if(!this._corners||!this._img.complete) return; this._resize(); const s=this._map.getSize(); const ctx=this._ctx; ctx.clearRect(0,0,s.x,s.y);
        const p=[ this._map.latLngToLayerPoint(this._corners[0]), this._map.latLngToLayerPoint(this._corners[1]), this._map.latLngToLayerPoint(this._corners[2]), this._map.latLngToLayerPoint(this._corners[3]) ];
        // tri A (NW,NE,SE)
        this._drawTri(ctx, [p[0],p[1],p[2]], [0,0, this._img.width,0, this._img.width,this._img.height]);
        // tri B (NW,SE,SW)
        this._drawTri(ctx, [p[0],p[2],p[3]], [0,0, this._img.width,this._img.height, 0,this._img.height]);
      }
      _drawTri(ctx, P, T){ const [x0,y0,x1,y1,x2,y2]=T; const [p0,p1,p2]=P; const denom=(x0*(y1-y2)+x1*(y2-y0)+x2*(y0-y1))||1;
        const a=(p0.x*(y1-y2)+p1.x*(y2-y0)+p2.x*(y0-y1))/denom;
        const b=(p0.y*(y1-y2)+p1.y*(y2-y0)+p2.y*(y0-y1))/denom;
        const c=(p0.x*(x2-x1)+p1.x*(x0-x2)+p2.x*(x1-x0))/denom;
        const d=(p0.y*(x2-x1)+p1.y*(x0-x2)+p2.y*(x1-x0))/denom;
        const e=(p0.x*(x1*y2-x2*y1)+p1.x*(x2*y0-x0*y2)+p2.x*(x0*y1-x1*y0))/denom;
        const f=(p0.y*(x1*y2-x2*y1)+p1.y*(x2*y0-x0*y2)+p2.y*(x0*y1-x1*y0))/denom;
        ctx.save(); ctx.setTransform(a,b,c,d,e,f); ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.lineTo(x2,y2); ctx.closePath(); ctx.clip(); ctx.drawImage(this._img,0,0); ctx.restore(); }
    }

    // Rektangulær fallback (viser alltid når fil finnes) – bak warp for å hjelpe visuelt
    let rectOverlay=null;
    function updateRectOverlay(){ try{ if(rectOverlay){ map.removeLayer(rectOverlay); rectOverlay=null; } }catch(_){ }
      const lats=[WARP_CORNERS.NW[0],WARP_CORNERS.NE[0],WARP_CORNERS.SE[0],WARP_CORNERS.SW[0]];
      const lngs=[WARP_CORNERS.NW[1],WARP_CORNERS.NE[1],WARP_CORNERS.SE[1],WARP_CORNERS.SW[1]];
      const sw=L.latLng(Math.min(...lats), Math.min(...lngs));
      const ne=L.latLng(Math.max(...lats), Math.max(...lngs));
      rectOverlay=L.imageOverlay(IMAGE_URL+'?v='+Date.now(), L.latLngBounds(sw,ne), { opacity:0.25, interactive:false });
      rectOverlay.addTo(map);
    }

    // --- Last bildet og legg på warp + fallback ---
    let warpLayer=null; const img=new Image();
    img.onload = ()=>{ setStatus('Bilde ok · '+img.width+'×'+img.height); updateRectOverlay(); warpLayer=new Warp2DLayer(img); warpLayer.addTo(map); warpLayer.setCorners([ WARP_CORNERS.NW, WARP_CORNERS.NE, WARP_CORNERS.SE, WARP_CORNERS.SW ]); };
    img.onerror = ()=>{ setStatus('Fant ikke Turkart.png i rot'); };
    img.src = IMAGE_URL + '?v=' + Date.now();

    // --- POIs (read-only) + ruter ved popup ---
    const poiLayer = L.featureGroup().addTo(map);
    const routeLayer = L.featureGroup().addTo(map);

    function makePopupHTML(p){ const t=p.title||'Uten navn'; const d=p.desc||''; return `<div style="min-width:180px"><strong>${escapeHTML(t)}</strong>${d?`<p style=\"margin:6px 0 0\">${escapeHTML(d)}</p>`:''}</div>`; }
    function escapeHTML(s=''){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }

    function addMarker(p){ const m=L.marker([p.lat,p.lng]).addTo(poiLayer).bindPopup(makePopupHTML(p));
      m.on('popupopen', ()=>{ drawRoutesForPoint(p); });
      m.on('popupclose', ()=>{ routeLayer.clearLayers(); });
      return m; }

    function drawRoutesForPoint(p){ routeLayer.clearLayers();
      // Støtt flere mulige feltnavn
      // 1) p.route = [[lat,lng], ...]
      if (Array.isArray(p.route) && p.route.length && Array.isArray(p.route[0])){
        L.polyline(p.route, { color: p.color||'#0a7cff', weight:4, opacity:.9 }).addTo(routeLayer);
      }
      // 2) p.routes = [ [[lat,lng],...], ... ]
      else if (Array.isArray(p.routes) && p.routes.length && Array.isArray(p.routes[0])){
        p.routes.forEach(r => { if (Array.isArray(r) && r.length) L.polyline(r, { color: p.color||'#0a7cff', weight:4, opacity:.9 }).addTo(routeLayer); });
      }
      // 3) p.route.coords = [[lat,lng],...]
      else if (p.route && Array.isArray(p.route.coords)){
        L.polyline(p.route.coords, { color: p.route.color||p.color||'#0a7cff', weight:4, opacity:.9 }).addTo(routeLayer);
      }
    }

    async function loadPOIs(){
      try{
        const res = await fetch('pois.json', { cache:'no-store' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        const points = Array.isArray(data.points) ? data.points : (Array.isArray(data) ? data : []);
        points.forEach(addMarker);
        setStatus('Klar');
      } catch(e){ setStatus('POIs mangler – viser bare kart og bilde'); }
    }

    loadPOIs();

    // Eksponer minimal debug
    window.Kartvaaler = { map };
  </script>
</body>
</html>
