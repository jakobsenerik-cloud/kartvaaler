<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Kartvaaler – Mobil-zoom Fix (v-debug2) – PC pan fix + REDIGERING</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<style>
  html, body { height: 100%; margin: 0; background:#eaf0f4; }
  #map { position: absolute; inset: 0; }
  #ui { position: absolute; z-index: 1000; top: 10px; left: 10px; background: rgba(255,255,255,.95); padding: 8px 10px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,.12); font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  #ui label { display:flex; align-items:center; gap:6px }
  #status { font-size: 12px; color:#334155 }
  #ver { font-size:12px; color:#0f172a; background:#e2e8f0; border-radius:6px; padding:2px 6px }
  input[type=range]{ width:120px }
  button{ padding:6px 10px; border:1px solid #d0d7de; border-radius:8px; background:#fff; cursor:pointer }
  .leaflet-container { background:#e8eef2; }

  /* Canvas: lar muse-drag/pan passere til kartet */
  .warp-pane, .warp-pane canvas { pointer-events: none; }
  .warp-pane canvas { position:absolute; left:0; top:0; }

  /* POI ikoner */
  .poi-icon svg { display:block }
  .leaflet-tooltip.mytooltip { background:rgba(255,255,255,.95); border:1px solid #e5e7eb; color:#111827; border-radius:6px; box-shadow:0 6px 16px rgba(0,0,0,.12); }
  .leaflet-tooltip.mytooltip::before { border-top-color:#e5e7eb; }

  /* Redigeringspanel (flyttbar) */
  #editor { position: absolute; z-index: 1200; top: 90px; left: 10px; width: 320px; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.15); display: none; }
  #editor header { cursor: move; user-select: none; padding: 10px 12px; background: #f8fafc; border-bottom: 1px solid #e5e7eb; border-radius: 10px 10px 0 0; font-weight: 600; display:flex; align-items:center; justify-content:space-between }
  #editor .content { padding: 10px 12px; }
  #editor .row { display:flex; gap:8px; margin-bottom:8px; }
  #editor .row label { width: 90px; font-size:12px; color:#374151; display:flex; align-items:center }
  #editor input[type=text], #editor select, #editor textarea, #editor input[type=url] { flex: 1; padding: 6px 8px; border:1px solid #d1d5db; border-radius:8px; font: 14px/1.3 system-ui; }
  #editor textarea { height:80px; resize: vertical; }
  #editor .btns { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  #editor .btns button { padding:6px 10px; border-radius:8px; border:1px solid #d1d5db; background:#fff; cursor:pointer }
  #editor .danger { border-color:#ef4444; color:#ef4444 }
  #editor footer { padding: 8px 12px 12px; display:flex; gap:8px; justify-content:flex-end }

  /* Rute-redigering hint */
  .hint { font-size:12px; color:#475569; margin-top:4px }
</style>
</head>
<body>
  <div id="map"></div>
  <div id="ui">
    <button id="fitBtn">Vis kartområdet</button>
    <label>Opasitet <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.95"></label>
    <button id="centerMe">Sentrer meg</button>
    <button id="startPrecise">Vis min posisjon</button>
    <button id="stopWatch">Stopp</button>

    <label style="margin-left:6px"><input id="poiToggle" type="checkbox" checked> Vis punkter</label>

    <span style="border-left:1px solid #e5e7eb;height:20px"></span>
    <label><input id="editToggle" type="checkbox"> Rediger</label>
    <button id="addPoiBtn" disabled>Legg til punkt</button>
    <button id="saveJsonBtn" disabled>Lagre som JSON</button>
    <input id="loadFile" type="file" accept="application/json" style="display:none"/>
    <button id="loadJsonBtn" disabled>Last fra fil</button>

    <span id="status">Laster…</span>
    <span id="ver"></span>
  </div>

  <!-- Redigeringspanel -->
  <div id="editor">
    <header>
      <span id="edTitle">Rediger punkt</span>
      <button id="edClose" title="Lukk" style="border:none;background:none;font-size:18px;line-height:1;cursor:pointer">✕</button>
    </header>
    <div class="content">
      <div class="row"><label>Tittel</label><input id="f_title" type="text"></div>
      <div class="row"><label>Kategori</label>
        <select id="f_category">
          <option>Parkering</option>
          <option>Badeplass</option>
          <option>Utsiktspunkt</option>
          <option>Husmannsplass</option>
          <option>Båtslipp</option>
          <option>Matbutikk</option>
          <option>Bensinstasjon</option>
          <option>Aktivitet</option>
          <option>Kulturminne</option>
          <option>Interessepunkt</option>
          <option>Turforslag</option>
        </select>
      </div>
      <div class="row"><label>Farge</label><input id="f_color" type="color" value="#3b82f6"></div>
      <div class="row"><label>Lenke</label><input id="f_link" type="url" placeholder="https://..."></div>
      <div class="row"><label>Bilde-URL</label><input id="f_image" type="url" placeholder="https://..."></div>
      <div class="row"><label>Beskrivelse</label><textarea id="f_desc"></textarea></div>

      <div class="btns">
        <button id="routeStartBtn">Rediger rute</button>
        <button id="routeUndoBtn" disabled>Angre siste</button>
        <button id="routeClearBtn" class="danger" disabled>Tøm rute</button>
        <div class="hint">I rute-modus: klikk i kartet for å legge til rute-punkter. Avslutt med «Rediger rute» igjen.</div>
      </div>

      <div class="btns">
        <button id="delPoiBtn" class="danger">Slett punkt</button>
      </div>
    </div>
    <footer>
      <button id="edSave">Lagre</button>
    </footer>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function(){
  const VERSION='v-debug2 pc-pan+edit ' + new Date().toISOString().slice(0,16).replace('T',' ');
  const statusEl=document.getElementById('status');
  const setStatus=(m)=> statusEl.textContent=m;
  document.getElementById('ver').textContent=VERSION;
  window.addEventListener('error', e=> setStatus('JS-feil: '+(e.message||'ukjent')));
  window.addEventListener('unhandledrejection', e=>{const r=e.reason||{}; setStatus('Promise-feil: '+(r.message||r));});

  // --- konfig ---
  const IMAGE_URL='Turkart.png?v='+Date.now();
  // Hjørner i rekkefølge: NW, NE, SE, SW (WGS84 / lat,lng)
  const CORNERS=[
    [59.54593535667747, 10.765142440795898],
    [59.539561484456776, 11.201162338256838],
    [59.380786150970934, 11.190948486328127],
    [59.387167906588274, 10.756945610046387]
  ];

  // --- Leaflet kart ---
  const map=L.map('map', {
    zoomControl:true,
    zoomAnimation:false,
    fadeAnimation:false,
    inertia:true,
    wheelDebounceTime: 30,
    wheelPxPerZoomLevel: 120,
    tap:false
  });
  // sikre panorering/zoom på PC
  map.dragging.enable(); map.scrollWheelZoom.enable(); map.keyboard.enable();

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap-bidragsytere'
  }).addTo(map);

  // --- Canvas warp i overlayPane, forankret til lagets (0,0) ---
  const warpRoot = L.DomUtil.create('div','warp-pane', map.getPanes().overlayPane);
  warpRoot.style.pointerEvents = 'none';
  const canvas=document.createElement('canvas');
  const ctx=canvas.getContext('2d');
  warpRoot.appendChild(canvas);
  let img=new Image(), imgW=0, imgH=0, layerOrigin=L.point(0,0);
  img.onload=()=>{ imgW=img.naturalWidth; imgH=img.naturalHeight; renderWarp(false); setStatus('Klar'); };
  img.onerror=()=> setStatus('Klarte ikke å laste Turkart.png');
  img.src=IMAGE_URL;

  const CORNERS_LL=CORNERS.map(([lat,lng])=>L.latLng(lat,lng));
  const bounds=L.latLngBounds(CORNERS_LL);
  function fitView(){ map.fitBounds(bounds, { padding:[10,10] }); }
  document.getElementById('fitBtn').onclick=fitView;

  function resizeCanvas(){
    const sz = map.getSize();
    canvas.width = sz.x; canvas.height = sz.y;
    const pos = map.containerPointToLayerPoint([0,0]);
    layerOrigin = L.point(pos.x, pos.y);
    L.DomUtil.setPosition(canvas, pos);
  }
  function setTriTransform(ctx,s0,s1,s2,d0,d1,d2){
    const a11=s1.x-s0.x,a12=s2.x-s0.x,a21=s1.y-s0.y,a22=s2.y-s0.y; const det=a11*a22-a12*a21; if(Math.abs(det)<1e-12){ ctx.setTransform(1,0,0,1,0,0); return; }
    const inv11=a22/det, inv12=-a12/det, inv13=-(inv11*s0.x+inv12*s0.y);
    const inv21=-a21/det, inv22=a11/det, inv23=-(inv21*s0.x+inv22*s0.y);
    const b11=d1.x-d0.x, b12=d2.x-d0.x, b13=d0.x; const b21=d1.y-d0.y, b22=d2.y-d0.y, b23=d0.y;
    const A=b11*inv11+b12*inv21, B=b21*inv11+b22*inv21; const C=b11*inv12+b12*inv22, D=b21*inv12+b22*inv22; const E=b11*inv13+b12*inv23+b13, F=b21*inv13+b22*inv23+b23;
    ctx.setTransform(A,B,C,D,E,F);
  }
  const lerp=(a,b,t)=> a+(b-a)*t; const lerpPt=(p,q,t)=> ({x:lerp(p.x,q.x,t), y:lerp(p.y,q.y,t)});

  const opacity=document.getElementById('opacity');
  opacity.addEventListener('input', ()=> renderWarp(false));

  function llToCanvas(ll){ const p = map.latLngToLayerPoint(ll); return { x: p.x - layerOrigin.x, y: p.y - layerOrigin.y }; }

  function renderWarp(quick=false){ if(!imgW||!imgH) return; resizeCanvas(); ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.globalAlpha=parseFloat(opacity.value||'0.95');
    const [NW,NE,SE,SW]=CORNERS_LL.map(ll=>llToCanvas(ll));
    const COLS= quick? 8 : 22, ROWS= quick? 8 : 22;
    for(let j=0;j<ROWS;j++){
      const v0=j/ROWS, v1=(j+1)/ROWS; const L0=lerpPt(NW,SW,v0), R0=lerpPt(NE,SE,v0); const L1=lerpPt(NW,SW,v1), R1=lerpPt(NE,SE,v1);
      for(let i=0;i<COLS;i++){
        const u0=i/COLS, u1=(i+1)/COLS; const Q00=lerpPt(L0,R0,u0), Q10=lerpPt(L0,R0,u1); const Q01=lerpPt(L1,R1,u0), Q11=lerpPt(L1,R1,u1);
        ctx.save(); ctx.beginPath(); ctx.moveTo(Q00.x,Q00.y); ctx.lineTo(Q10.x,Q10.y); ctx.lineTo(Q11.x,Q11.y); ctx.closePath(); ctx.clip();
        const S00={x:u0*imgW, y:v0*imgH}, S10={x:u1*imgW, y:v0*imgH}, S11={x:u1*imgW, y:v1*imgH}; setTriTransform(ctx,S00,S10,S11,Q00,Q10,Q11); ctx.drawImage(img,0,0); ctx.restore();
        ctx.save(); ctx.beginPath(); ctx.moveTo(Q00.x,Q00.y); ctx.lineTo(Q11.x,Q11.y); ctx.lineTo(Q01.x,Q01.y); ctx.closePath(); ctx.clip();
        const S01={x:u0*imgW, y:v1*imgH}; setTriTransform(ctx,S00,S11,S01,Q00,Q11,Q01); ctx.drawImage(img,0,0); ctx.restore();
      }
    }
    ctx.restore(); }

  let rafPending=false; function requestQuick(){ if(rafPending) return; rafPending=true; requestAnimationFrame(()=>{ rafPending=false; renderWarp(true); }); }
  map.on('move', requestQuick); map.on('zoom', requestQuick); map.on('moveend zoomend resize', ()=> renderWarp(false));
  fitView();

  // --- GPS ---
  const dropIcon=L.divIcon({ className:'poi-icon', html:`<svg width="24" height="24" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><path d=\"M14 1 C8 1 4 5.5 4 10.5 c0 6.5 8 13 10 16 2-3 10-9.5 10-16 C24 5.5 20 1 14 1z\" fill=\"#2563eb\" stroke=\"white\" stroke-width=\"2\"/><circle cx=\"14\" cy=\"11\" r=\"3.5\" fill=\"white\"/></svg>` });
  let userMarker=null, accCircle=null, watchId=null;
  function showUser(lat,lng,acc){ const ll=L.latLng(lat,lng); if(!userMarker){ userMarker=L.marker(ll,{icon:dropIcon}).addTo(map); } else userMarker.setLatLng(ll); if(!accCircle){ accCircle=L.circle(ll,{ radius:acc||0, color:'#2563eb', weight:1, fillOpacity:0.08 }).addTo(map); } accCircle.setLatLng(ll); if(acc!=null) accCircle.setRadius(acc); }
  function startPrecise(){ if(!navigator.geolocation){ setStatus('Geolocation ikke støttet'); return; } stopWatch(); setStatus('Sporer (presis)…'); watchId=navigator.geolocation.watchPosition(pos=>{ showUser(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy); setStatus(`Sporer: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)} (±${Math.round(pos.coords.accuracy)} m)`); }, err=>{ const code=({1:'PERMISSION_DENIED',2:'POSITION_UNAVAILABLE',3:'TIMEOUT'})[err.code]||'ERROR'; setStatus(`Sporing feilet: ${code} – ${err.message}`); }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 }); }
  function centerMe(){ if(userMarker){ map.panTo(userMarker.getLatLng()); return; } if(!navigator.geolocation){ setStatus('Geolocation ikke støttet'); return; } setStatus('Henter posisjon…'); navigator.geolocation.getCurrentPosition(pos=>{ showUser(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy); map.setView([pos.coords.latitude,pos.coords.longitude], map.getZoom()); setStatus(`Posisjon: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)} (±${Math.round(pos.coords.accuracy)} m)`); }, err=>{ const code=({1:'PERMISSION_DENIED',2:'POSITION_UNAVAILABLE',3:'TIMEOUT'})[err.code]||'ERROR'; setStatus(`Kunne ikke hente posisjon: ${code} – ${err.message}`); }, { enableHighAccuracy:false, timeout:8000, maximumAge:120000 }); }
  function stopWatch(){ if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; setStatus('Sporing stoppet'); } }
  document.getElementById('startPrecise').onclick=startPrecise; document.getElementById('centerMe').onclick=centerMe; document.getElementById('stopWatch').onclick=stopWatch;

  // --- POI-lag og ruter ---
  const poiToggle=document.getElementById('poiToggle');
  const editToggle=document.getElementById('editToggle');
  const poiLayer=L.layerGroup().addTo(map);
  const routeLines=new Map();
  let POIS=[]; // lastes fra fil eller LS

  function colorForCategory(cat){
    const key=(cat||'').toString().toLowerCase();
    const mapC={ 'parkering':'#0ea5e9','badeplass':'#06b6d4','utsiktspunkt':'#8b5cf6','husmannsplass':'#92400e','båtslipp':'#0284c7','matbutikk':'#22c55e','bensinstasjon':'#ef4444','aktivitet':'#f97316','kulturminne':'#b91c1c','interessepunkt':'#14b8a6','turforslag':'#3b82f6','turmål':'#22c55e','': '#6b7280' }; return mapC[key]||'#6b7280'; }
  function iconHtml(color){ return `<svg width="24" height="24" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><path d=\"M14 1 C8 1 4 5.5 4 10.5 c0 6.5 8 13 10 16 2-3 10-9.5 10-16 C24 5.5 20 1 14 1z\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/><circle cx=\"14\" cy=\"11\" r=\"3.5\" fill=\"white\"/></svg>`; }
  function mkIcon(color){ return L.divIcon({ className:'poi-icon', html:iconHtml(color), iconSize:[24,24], iconAnchor:[12,22] }); }

  function toLatLngAny(pt){ if(Array.isArray(pt)){ const a=parseFloat(pt[0]); const b=parseFloat(pt[1]); if(Number.isNaN(a)||Number.isNaN(b)) return null; if(b>50 && a<30) return L.latLng(b,a); return L.latLng(a,b); } else if (pt && typeof pt==='object'){ const lat=parseFloat(pt.lat ?? pt.latitude ?? pt.y ?? pt[1]); const lng=parseFloat(pt.lng ?? pt.lon ?? pt.longitude ?? pt.x ?? pt[0]); if(Number.isNaN(lat)||Number.isNaN(lng)) return null; return L.latLng(lat,lng);} return null; }
  function normPath(path){ const out=[]; if(!Array.isArray(path)) return out; for(const pt of path){ const ll=toLatLngAny(pt); if(ll) out.push(ll);} return out; }

  const markerById=new Map();

  function rebuildPOIs(){
    poiLayer.clearLayers(); markerById.clear();
    for(const p of POIS){ if(typeof p.lat!=="number"||typeof p.lng!=="number") continue; const color=p.color||colorForCategory(p.category); const m=L.marker([p.lat,p.lng], { icon: mkIcon(color), draggable: !!editToggle.checked }).addTo(poiLayer); markerById.set(p.id, m);
      // Tooltip kun i visningsmodus
      if(!editToggle.checked && p.title) m.bindTooltip(p.title, { direction:'top', opacity:0.95, offset:[0,-18], className:'mytooltip' });
      // Popup med kort info i visningsmodus
      if(!editToggle.checked){ const parts=[]; parts.push(`<h3 style=\"margin:0 0 6px\">${escapeHtml(p.title||'Punkt')}</h3>`); if(p.desc) parts.push(`<div style=\"margin:0 0 8px\">${escapeHtml(p.desc)}</div>`); parts.push(`<div style=\"font-size:12px;color:#374151\">Kategori: ${escapeHtml(p.category||'—')}</div>`); if(p.link) parts.push(`<div style=\"margin-top:6px\"><a href=\"${escapeAttr(p.link)}\" target=\"_blank\" rel=\"noopener\">Mer info ↗</a></div>`); m.bindPopup(parts.join('')); }
      // Redigering
      if(editToggle.checked){ m.on('click', ()=> openEditor(p.id)); m.on('dragend', ev=>{ const latlng=ev.target.getLatLng(); p.lat=latlng.lat; p.lng=latlng.lng; setStatus(`Flyttet: ${p.title||p.id}`); }); }
      // Rutevisning i visningsmodus (kun når popup er åpen)
      if(!editToggle.checked && Array.isArray(p.path) && p.path.length>=2){ const colorLine=p.color||colorForCategory(p.category); m.on('popupopen', ()=>{ if(routeLines.has(p.id)) return; const latlngs=normPath(p.path); if(latlngs.length<2) return; const line=L.polyline(latlngs, { color: colorLine, weight:9, opacity:0.5, lineJoin:'round', lineCap:'round' }).addTo(map); routeLines.set(p.id, line); }); m.on('popupclose', ()=>{ const line=routeLines.get(p.id); if(line){ map.removeLayer(line); routeLines.delete(p.id); } }); }
    }
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function escapeAttr(s){ return String(s||'').replace(/\"/g,'&quot;'); }

  // --- Last/lagre ---
  const STORAGE_KEY='kartvaaler_pois_v1';
  function saveToLocal(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(POIS)); setStatus('Lagret lokalt'); }catch{ setStatus('Kunne ikke lagre lokalt'); } }
  function loadFromLocal(){ try{ const s=localStorage.getItem(STORAGE_KEY); if(s){ POIS=JSON.parse(s)||[]; rebuildPOIs(); setStatus('Lastet fra lokal lagring'); } }catch{ setStatus('Kunne ikke lese lokal lagring'); } }

  // initial: prøv JSON-fil, ellers lokal lagring
  fetch('pois.json?v='+Date.now(), {cache:'no-store'})
    .then(r=> r.ok ? r.json() : [])
    .then(arr=>{ if(Array.isArray(arr) && arr.length){ POIS=arr; setStatus('Klar (POI: '+arr.length+')'); } else { loadFromLocal(); if(!POIS.length){ POIS=[]; setStatus('Klar (0 POI)'); } } rebuildPOIs(); })
    .catch(()=>{ loadFromLocal(); if(!POIS.length){ POIS=[]; } rebuildPOIs(); setStatus('Klar (offline-POI: '+POIS.length+')'); });

  // --- Redigering UI ---
  const addPoiBtn=document.getElementById('addPoiBtn');
  const saveJsonBtn=document.getElementById('saveJsonBtn');
  const loadJsonBtn=document.getElementById('loadJsonBtn');
  const loadFile=document.getElementById('loadFile');

  editToggle.addEventListener('change', ()=>{
    const on=editToggle.checked;
    addPoiBtn.disabled = !on; saveJsonBtn.disabled=!on; loadJsonBtn.disabled=!on;
    // lukk evt rutevisninger
    for(const [id,line] of routeLines){ map.removeLayer(line); } routeLines.clear();
    rebuildPOIs();
  });

  addPoiBtn.onclick=()=>{
    if(!editToggle.checked) return; const c=map.getCenter(); const id='p'+Date.now();
    const p={ id, title:'Nytt punkt', category:'Interessepunkt', color:'#3b82f6', lat:c.lat, lng:c.lng, desc:'' };
    POIS.push(p); rebuildPOIs(); openEditor(id); saveToLocal();
  };

  saveJsonBtn.onclick=()=>{
    const blob=new Blob([JSON.stringify(POIS, null, 2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pois.json'; a.click(); setStatus('Lastet ned pois.json');
  };
  loadJsonBtn.onclick=()=> loadFile.click();
  loadFile.onchange=(ev)=>{
    const f=ev.target.files?.[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ const arr=JSON.parse(reader.result); if(Array.isArray(arr)){ POIS=arr; rebuildPOIs(); saveToLocal(); setStatus('POI lastet fra fil: '+arr.length); } else setStatus('Filen inneholdt ikke en liste'); }catch(err){ setStatus('Feil ved lesing: '+err.message); } }; reader.readAsText(f);
  };

  // --- Editor panel (draggable) ---
  const editor=document.getElementById('editor');
  const edClose=document.getElementById('edClose');
  const f_title=document.getElementById('f_title');
  const f_category=document.getElementById('f_category');
  const f_color=document.getElementById('f_color');
  const f_link=document.getElementById('f_link');
  const f_image=document.getElementById('f_image');
  const f_desc=document.getElementById('f_desc');
  const edSave=document.getElementById('edSave');
  const edHeader=editor.querySelector('header');
  const routeStartBtn=document.getElementById('routeStartBtn');
  const routeUndoBtn=document.getElementById('routeUndoBtn');
  const routeClearBtn=document.getElementById('routeClearBtn');

  let activeId=null; let routeEdit=false; let routeTempLine=null;

  function openEditor(id){ if(!editToggle.checked) return; const p=POIS.find(x=>x.id===id); if(!p) return; activeId=id; document.getElementById('edTitle').textContent=p.title||'Punkt'; editor.style.display='block';
    f_title.value=p.title||''; f_category.value=p.category||'Interessepunkt'; f_color.value=p.color||colorForCategory(p.category); f_link.value=p.link||''; f_image.value=p.image||''; f_desc.value=p.desc||''; routeEdit=false; routeUndoBtn.disabled=!Array.isArray(p.path)||p.path.length===0; routeClearBtn.disabled=routeUndoBtn.disabled; }
  function closeEditor(){ activeId=null; editor.style.display='none'; stopRouteEdit(); }
  edClose.onclick=closeEditor;

  edSave.onclick=()=>{ if(!activeId) return; const p=POIS.find(x=>x.id===activeId); if(!p) return; p.title=f_title.value.trim(); p.category=f_category.value; p.color=f_color.value; p.link=f_link.value.trim(); p.image=f_image.value.trim(); p.desc=f_desc.value.trim(); const m=markerById.get(p.id); if(m) m.setIcon(mkIcon(p.color||colorForCategory(p.category))); rebuildPOIs(); saveToLocal(); setStatus('Lagret punkt'); };

  document.getElementById('delPoiBtn').onclick=()=>{ if(!activeId) return; const i=POIS.findIndex(x=>x.id===activeId); if(i>=0){ if(confirm('Slette punktet?')){ const p=POIS[i]; const m=markerById.get(p.id); if(m) poiLayer.removeLayer(m); POIS.splice(i,1); markerById.delete(activeId); const line=routeLines.get(activeId); if(line){ map.removeLayer(line); routeLines.delete(activeId); } closeEditor(); rebuildPOIs(); saveToLocal(); setStatus('Punkt slettet'); } } };

  // Draggable editor
  (function(){ let sx=0, sy=0, ox=0, oy=0, drag=false; edHeader.addEventListener('mousedown', e=>{ drag=true; sx=e.clientX; sy=e.clientY; const r=editor.getBoundingClientRect(); ox=r.left; oy=r.top; e.preventDefault(); }); window.addEventListener('mousemove', e=>{ if(!drag) return; const nx=ox+(e.clientX-sx); const ny=oy+(e.clientY-sy); editor.style.left=Math.max(10, Math.min(window.innerWidth-340, nx))+'px'; editor.style.top=Math.max(60, Math.min(window.innerHeight-40, ny))+'px'; }); window.addEventListener('mouseup', ()=> drag=false); })();

  // Rute-redigering
  function startRouteEdit(){ if(!activeId) return; routeEdit=true; routeUndoBtn.disabled=false; routeClearBtn.disabled=false; setStatus('Rute-modus: klikk i kartet for å legge til punkter'); }
  function stopRouteEdit(){ routeEdit=false; if(routeTempLine){ map.removeLayer(routeTempLine); routeTempLine=null; } }
  routeStartBtn.onclick=()=>{ routeEdit = !routeEdit; routeStartBtn.textContent = routeEdit ? 'Avslutt rute' : 'Rediger rute'; if(routeEdit) startRouteEdit(); else stopRouteEdit(); };
  routeUndoBtn.onclick=()=>{ if(!activeId) return; const p=POIS.find(x=>x.id===activeId); if(!p) return; if(Array.isArray(p.path) && p.path.length){ p.path.pop(); drawTempRoute(p); saveToLocal(); }
    routeUndoBtn.disabled=!(p.path && p.path.length); routeClearBtn.disabled=routeUndoBtn.disabled; };
  routeClearBtn.onclick=()=>{ if(!activeId) return; const p=POIS.find(x=>x.id===activeId); if(!p) return; if(confirm('Tømme ruten?')){ p.path=[]; drawTempRoute(p); saveToLocal(); routeUndoBtn.disabled=true; routeClearBtn.disabled=true; } };

  function drawTempRoute(p){ const latlngs=normPath(p.path||[]); if(routeTempLine){ map.removeLayer(routeTempLine); routeTempLine=null; } if(latlngs.length>=2){ const color=p.color||colorForCategory(p.category); routeTempLine=L.polyline(latlngs, { color, weight:9, opacity:0.5, lineJoin:'round', lineCap:'round' }).addTo(map); }
  }

  map.on('click', (e)=>{ if(!routeEdit || !activeId) return; const p=POIS.find(x=>x.id===activeId); if(!p) return; if(!Array.isArray(p.path)) p.path=[]; p.path.push([e.latlng.lat, e.latlng.lng]); drawTempRoute(p); saveToLocal(); });

  // Toggle lag
  document.getElementById('poiToggle').addEventListener('change', ()=>{ if(poiToggle.checked) poiLayer.addTo(map); else poiLayer.remove(); });

})();
</script>
</body>
</html>
