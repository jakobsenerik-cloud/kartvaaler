<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kartvaaler – Diagnose (minimal)</title>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    #log { position: fixed; right: 10px; top: 10px; width: min(420px, 90vw); max-height: 60vh; overflow: auto; background: rgba(20,20,20,.85); color: #d6f5ff; padding: 10px; border-radius: 8px; font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, monospace; white-space: pre-wrap; z-index: 2000; }
    #log.hide { display: none; }
    #note { position: fixed; left: 10px; bottom: 10px; background: rgba(255,255,255,.95); padding: 8px 10px; border-radius: 8px; font: 13px system-ui, sans-serif; z-index: 2001; box-shadow: 0 4px 12px rgba(0,0,0,.15); }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="map"></div>
  <pre id="log">Starter logg … (trykk D for å skjule/vis)</pre>
  <div id="note">Denne versjonen viser kun OSM + <code>Turkart.png</code> (rektangulært) + POI-markører. Ingen warp eller rute-UI ennå. Poenget er å sikre at bildet faktisk lastes og vises. Når dette fungerer, skrur vi på warp igjen.</div>

  <!-- 1) Ekstremt tidlig feillogger i EGEN script-tag -->
  <script>
  (function(){
    var logEl = document.getElementById('log');
    function w(){
      var parts = [];
      for (var i=0;i<arguments.length;i++) {
        try { parts.push(typeof arguments[i]==='string' ? arguments[i] : JSON.stringify(arguments[i])); }
        catch(e){ parts.push(String(arguments[i])); }
      }
      logEl.textContent += "\n" + parts.join(' ');
      logEl.scrollTop = logEl.scrollHeight;
    }
    window.__w = w;
    window.addEventListener('error', function(e){ w('[window.error]', e.message); if (e.error && e.error.stack) w(e.error.stack); });
    window.addEventListener('unhandledrejection', function(e){ w('[unhandledrejection]', (e.reason && e.reason.message) ? e.reason.message : String(e.reason)); });
    ['log','warn','error'].forEach(function(k){ var orig = console[k]; console[k] = function(){ w('[console.'+k+']', Array.prototype.slice.call(arguments).join(' ')); if (orig) try{ orig.apply(console, arguments); }catch(_){} }; });
    document.addEventListener('keydown', function(e){ if ((e.key||'').toLowerCase()==='d') logEl.classList.toggle('hide'); });
    w('Feillogger aktiv.');
  })();
  </script>

  <!-- 2) Leaflet JS i egen tag (hvis denne feiler, ser vi det i loggen over) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" onload="__w('Leaflet lastet.')" onerror="__w('Klarte ikke laste Leaflet.js')"></script>

  <!-- 3) Hovedapp i egen tag (ENKEL – ingen warp/tegn, kun rektangulært bilde + POIs) -->
  <script>
  (function(){
    function start(){
      if (!window.L) { __w('Leaflet er ikke lastet, avbryter.'); return; }
      __w('Init kart …');
      var map = L.map('map').setView([59.48, 10.98], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' })
        .on('load', function(){ __w('OSM-tiles lastet.'); })
        .addTo(map);

      // Hjørner (fra deg)
      var WARP_CORNERS = {
        NW: [59.54593535667747, 10.765142440795898],
        NE: [59.539561484456776, 11.201162338256838],
        SE: [59.380786150970934, 11.190948486328127],
        SW: [59.387167906588274, 10.756945610046387]
      };

      // 3a) Vis Turkart.png rektangulært (min/max av hjørnene) – garantert synlig hvis fila finnes
      var lats = [WARP_CORNERS.NW[0], WARP_CORNERS.NE[0], WARP_CORNERS.SE[0], WARP_CORNERS.SW[0]];
      var lngs = [WARP_CORNERS.NW[1], WARP_CORNERS.NE[1], WARP_CORNERS.SE[1], WARP_CORNERS.SW[1]];
      var sw = L.latLng(Math.min.apply(null, lats), Math.min.apply(null, lngs));
      var ne = L.latLng(Math.max.apply(null, lats), Math.max.apply(null, lngs));

      // Last bilde eksplisitt for å logge suksess/størrelse
      var img = new Image();
      img.onload = function(){
        __w('Turkart.png lastet: ' + img.width + 'x' + img.height);
        try {
          L.imageOverlay('Turkart.png?v=' + Date.now(), L.latLngBounds(sw, ne), { opacity: 0.7 }).addTo(map);
          __w('La til rektangulær overlay.');
        } catch (e) {
          __w('Klarte ikke legge til overlay:', e.message);
        }
      };
      img.onerror = function(){
        __w('Fant ikke Turkart.png i rotmappa. Test URL i ny fane: /Turkart.png');
      };
      img.src = 'Turkart.png?v=' + Date.now();

      // 3b) POIs (leser samme format som før)
      fetch('pois.json', { cache: 'no-store' })
        .then(function(res){ __w('pois.json status ' + res.status); return res.ok ? res.json() : Promise.reject('HTTP ' + res.status); })
        .then(function(data){
          var points = Array.isArray(data.points) ? data.points : (Array.isArray(data) ? data : []);
          __w('POI punkter: ' + points.length);
          points.forEach(function(p){
            L.marker([p.lat, p.lng]).addTo(map).bindPopup((p.title||'Uten navn'));
          });
        })
        .catch(function(err){ __w('Kunne ikke laste POIs: ' + err); });

      // 3c) Eksponer for enkel sjekk
      window.Kartvaaler = { map: map };
      __w('Klar. Hvis bildet ikke synes, sjekk loggen over for feil.');
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start); else start();
  })();
  </script>

  <noscript>
    <div style="position:fixed;inset:10px;background:#fff;border:2px solid #f33;padding:12px;border-radius:8px;z-index:3000;font:14px system-ui,sans-serif;">JavaScript er slått av. Slå på JavaScript for å vise kartet.</div>
  </noscript>
</body>
</html>
