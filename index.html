<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>Kartvaaler – Full Failsafe (Flat warp + POIs + Tools)</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet.Draw (ruteverktøy) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <style>
    html, body, #map { height:100%; margin:0; }
    /* Canvas‑warp ligger helt flatt over kartet */
    .leaflet-warp2d, .leaflet-warpgl { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }

    .toolbar { position:fixed; z-index:1100; top:10px; left:10px; display:flex; flex-wrap:wrap; gap:8px; background:rgba(255,255,255,.92); padding:8px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,.15); }
    .toolbar button { border:1px solid #e2e2e2; background:#fff; border-radius:8px; padding:8px 10px; cursor:pointer; }
    .toolbar button.primary { background:#0a7cff; color:#fff; border-color:#0a7cff; }

    .filters { position:fixed; z-index:1100; left:10px; bottom:10px; background:rgba(255,255,255,.92); padding:10px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,.15); display:none; }
    .filters.open { display:block; }
    .chips { display:flex; flex-wrap:wrap; gap:6px; }
    .chip { border:1px solid #ddd; border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; }
    .chip.active { background:#0a7cff; color:#fff; border-color:#0a7cff; }

    .panel { position:fixed; z-index:1100; right:10px; bottom:10px; width:min(360px,92vw); max-height:65vh; overflow:auto; background:rgba(255,255,255,.98); padding:12px 14px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.2); display:none; }
    .panel.open { display:block; }
    .panel h3 { margin:6px 0 10px; }
    .panel label { display:block; font-size:13px; margin:8px 0 4px; }
    .panel input[type="text"], .panel textarea, .panel select { width:100%; box-sizing:border-box; padding:8px 10px; border:1px solid #ddd; border-radius:8px; font-size:14px; }
    .panel .row { display:flex; gap:8px; }
    .panel .row > * { flex:1; }

    .toast { position:fixed; top:12px; left:50%; transform:translateX(-50%); z-index:1200; background:rgba(20,20,20,.9); color:#fff; padding:6px 10px; border-radius:10px; }
    .status { position:fixed; z-index:1100; right:10px; top:10px; background:rgba(255,255,255,.92); padding:8px 10px; border-radius:10px; font:12px/1.4 system-ui,sans-serif; box-shadow:0 4px 14px rgba(0,0,0,.15); }

    /* Ekstra: vis fatal JS-feil som overlay */
    .fatal { position:fixed; z-index:1300; inset:10px; background:rgba(255,230,230,.97); color:#900; border:1px solid #f55; padding:10px; overflow:auto; font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, monospace; white-space:pre-wrap; border-radius:10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <button id="btnEdit" class="primary">✎ Rediger: AV</button>
    <button id="btnAddPoint">＋ Punkt</button>
    <button id="btnRouteTool">Ruteverktøy</button>
    <button id="btnFilters">Filter</button>
    <button id="btnCalibrate">Kalibrer</button>
    <button id="btnCopyCorners">Kopier hjørner</button>
    <button id="btnSave">⬇︎ Lagre POIs</button>
  </div>
  <div id="filters" class="filters">
    <h4>Kategorier</h4>
    <div id="filterChips" class="chips"></div>
  </div>
  <div id="panel" class="panel" aria-live="polite">
    <h3 id="panelTitle">Rediger</h3>
    <div id="panelBody"></div>
    <div class="row" style="margin-top:10px; gap:8px;">
      <button id="btnApply" class="primary">Lagre endringer</button>
      <button id="btnDelete">Slett</button>
      <button id="btnClose">Lukk</button>
    </div>
  </div>
  <div id="status" class="status">Status: init…</div>
  <div id="toast" class="toast" hidden></div>
  <div id="fatal" class="fatal" hidden></div>

  <script>
    // --- Fatal error overlay ---
    const $fatal = document.getElementById('fatal');
    window.addEventListener('error', (e) => { $fatal.hidden=false; $fatal.textContent = '[FEIL] ' + e.message + '\n' + (e.error && e.error.stack ? e.error.stack : ''); });
    window.addEventListener('unhandledrejection', (e) => { $fatal.hidden=false; $fatal.textContent = '[PROMISE] ' + (e.reason && e.reason.message ? e.reason.message : e.reason); });

    // ---- Konstanter ----
    const IMAGE_URL = 'Turkart.png'; // må ligge i rot
    const WARP_CORNERS = {
      NW: [59.54593535667747, 10.765142440795898],
      NE: [59.539561484456776, 11.201162338256838],
      SE: [59.380786150970934, 11.190948486328127],
      SW: [59.387167906588274, 10.756945610046387]
    };
    const DEFAULT_CATEGORIES = [ 'Bebyggelse', 'skoler/barnehager', 'naturreservater' ];
    const MAP_CENTER = [59.48, 10.98];
    const MAP_ZOOM = 11;

    // ---- UI refs ----
    const $status = document.getElementById('status');
    function setStatus(s){ $status.textContent = 'Status: ' + s; }
    function toast(msg, ms=2500){ const t=document.getElementById('toast'); t.textContent=msg; t.hidden=false; clearTimeout(toast._t); toast._t=setTimeout(()=>t.hidden=true, ms); }

    const btnEdit = document.getElementById('btnEdit');
    const btnAddPoint = document.getElementById('btnAddPoint');
    const btnRouteTool = document.getElementById('btnRouteTool');
    const btnFilters = document.getElementById('btnFilters');
    const btnCalibrate = document.getElementById('btnCalibrate');
    const btnCopyCorners = document.getElementById('btnCopyCorners');
    const btnSave = document.getElementById('btnSave');
    const filterChips = document.getElementById('filterChips');
    const panel = document.getElementById('panel');
    const panelBody = document.getElementById('panelBody');
    const panelTitle = document.getElementById('panelTitle');
    const btnApply = document.getElementById('btnApply');
    const btnDelete = document.getElementById('btnDelete');
    const btnClose = document.getElementById('btnClose');

    // ---- Map ----
    const map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OSM' }).addTo(map);
    setStatus('kart klart');

    // ---- Warp 2D (alltid flat, funker overalt) ----
    class Warp2DLayer extends L.Layer{
      constructor(img){ super(); this._img = img; }
      onAdd(map){ this._map=map; this._c=L.DomUtil.create('canvas','leaflet-warp2d'); this._ctx=this._c.getContext('2d'); map.getPanes().overlayPane.appendChild(this._c); this._onMv=this._draw.bind(this); map.on('move zoom viewreset resize', this._onMv); this._resize(); this._draw(); }
      onRemove(map){ map.off('move zoom viewreset resize', this._onMv); this._c.remove(); }
      setCorners(c){ this._corners=c; this._draw(); }
      _resize(){ const s=map.getSize(); this._c.width=s.x; this._c.height=s.y; L.DomUtil.setPosition(this._c, L.point(0,0)); }
      _draw(){ if(!this._corners||!this._img.complete) return; this._resize(); const s=map.getSize(); const ctx=this._ctx; ctx.clearRect(0,0,s.x,s.y);
        const p=[ map.latLngToLayerPoint(this._corners[0]), map.latLngToLayerPoint(this._corners[1]), map.latLngToLayerPoint(this._corners[2]), map.latLngToLayerPoint(this._corners[3]) ];
        // Tri A (NW,NE,SE)
        this._drawTri(ctx, [p[0],p[1],p[2]], [0,0, this._img.width,0, this._img.width,this._img.height]);
        // Tri B (NW,SE,SW)
        this._drawTri(ctx, [p[0],p[2],p[3]], [0,0, this._img.width,this._img.height, 0,this._img.height]);
      }
      _drawTri(ctx, P, T){ const [x0,y0,x1,y1,x2,y2]=T; const [p0,p1,p2]=P; const denom=(x0*(y1-y2)+x1*(y2-y0)+x2*(y0-y1))||1;
        const a=(p0.x*(y1-y2)+p1.x*(y2-y0)+p2.x*(y0-y1))/denom;
        const b=(p0.y*(y1-y2)+p1.y*(y2-y0)+p2.y*(y0-y1))/denom;
        const c=(p0.x*(x2-x1)+p1.x*(x0-x2)+p2.x*(x1-x0))/denom;
        const d=(p0.y*(x2-x1)+p1.y*(x0-x2)+p2.y*(x1-x0))/denom;
        const e=(p0.x*(x1*y2-x2*y1)+p1.x*(x2*y0-x0*y2)+p2.x*(x0*y1-x1*y0))/denom;
        const f=(p0.y*(x1*y2-x2*y1)+p1.y*(x2*y0-x0*y2)+p2.y*(x0*y1-x1*y0))/denom;
        ctx.save(); ctx.setTransform(a,b,c,d,e,f); ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.lineTo(x2,y2); ctx.closePath(); ctx.clip(); ctx.drawImage(this._img,0,0); ctx.restore(); }
    }

    // ---- Last bilde og start warp‑lag ----
    let warpLayer; const img = new Image();
    img.onload = () => {
      setStatus(`bilde lastet ${img.width}×${img.height}`);
      warpLayer = new Warp2DLayer(img); warpLayer.addTo(map);
      warpLayer.setCorners([ WARP_CORNERS.NW, WARP_CORNERS.NE, WARP_CORNERS.SE, WARP_CORNERS.SW ]);
    };
    img.onerror = () => { setStatus('Fant ikke "Turkart.png" i rot'); toast('Mangler Turkart.png i rotmappa'); };
    img.src = IMAGE_URL;

    // ---- Kalibrering (draggable markører) ----
    const cornerMarkers = {}; let calOn=false;
    function updateFromMarkers(){ for(const k of ['NW','NE','SE','SW']){ const m=cornerMarkers[k]; if(!m) continue; const ll=m.getLatLng(); WARP_CORNERS[k]=[ll.lat,ll.lng]; }
      if (warpLayer) warpLayer.setCorners([ WARP_CORNERS.NW, WARP_CORNERS.NE, WARP_CORNERS.SE, WARP_CORNERS.SW ]);
    }
    function setCal(on){ calOn=(typeof on==='boolean')?on:!on; calOn=!calOn; // toggle
      calOn = !(!calOn); // ensure boolean
      btnCalibrate.classList.toggle('primary', calOn); btnCalibrate.textContent = calOn? 'Kalibrer (PÅ)':'Kalibrer';
      if (calOn){ for(const k of ['NW','NE','SE','SW']){ const m=cornerMarkers[k] || L.marker(WARP_CORNERS[k], { draggable:true, zIndexOffset:900 }).bindTooltip(k,{permanent:true, direction:'top', offset:[0,-12]}); if(!cornerMarkers[k]){ m.on('drag', updateFromMarkers); cornerMarkers[k]=m; } m.setLatLng(WARP_CORNERS[k]).addTo(map).openTooltip(); } updateFromMarkers(); }
      else{ for(const k of Object.keys(cornerMarkers)) try{ map.removeLayer(cornerMarkers[k]); }catch(_){} }
    }
    btnCalibrate.addEventListener('click', () => setCal());
    btnCopyCorners.addEventListener('click', async () => { const t='WARP_CORNERS = '+JSON.stringify(WARP_CORNERS,null,2); try{ await navigator.clipboard.writeText(t); toast('Hjørner kopiert'); } catch(_){ toast('Kopi feilet – marker og kopier manuelt'); } });

    // ---- POIs + ruter ----
    let POIData = { points: [], routes: [] };
    const poiLayer = L.featureGroup().addTo(map);
    const routeLayer = L.featureGroup().addTo(map);
    const markerIndex = new Map();
    const routeIndex = new Map();

    const drawControl = new L.Control.Draw({ position:'topleft', draw:{ marker:false, rectangle:false, circle:false, circlemarker:false, polygon:false, polyline:{ shapeOptions:{ weight:4 }, metric:true, showLength:true } }, edit:{ featureGroup: routeLayer, edit:true, remove:true } });
    let drawControlAdded=false;

    function uid(p='id'){ return `${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`; }
    function makePOIIcon(color='#ff3b30'){ return L.divIcon({ className:'poi', iconSize:[18,18], iconAnchor:[9,9], html:`<div style="width:16px;height:16px;border-radius:50%;border:2px solid #fff;background:${color};box-shadow:0 1px 6px rgba(0,0,0,.35)"></div>` }); }

    async function loadPOIs(){ try{ const res = await fetch('pois.json', { cache:'no-store' }); if(!res.ok) throw new Error('404 pois.json'); const data = await res.json(); POIData.points = Array.isArray(data.points) ? data.points : (Array.isArray(data)? data: []); POIData.routes = Array.isArray(data.routes) ? data.routes : []; setStatus('POIs lastet'); } catch(e){ console.warn('POIs feilet', e); setStatus('POIs ikke funnet – starter tomt'); POIData = { points: [], routes: [] }; }
      renderAll(); buildFilters(); }

    function renderAll(){ poiLayer.clearLayers(); routeLayer.clearLayers(); markerIndex.clear(); routeIndex.clear();
      // Routes
      for(const r of POIData.routes){ const line = L.polyline(r.coords || r.latlngs || [], { color:r.color||'#0a7cff', weight:4, opacity:.9 }).addTo(routeLayer); routeIndex.set(r.id, line); line.on('click', ()=>openRouteEditor(r.id)); }
      // Points
      for(const p of POIData.points){ addMarkerToMap(p); }
    }
    function addMarkerToMap(p){ const m=L.marker([p.lat,p.lng], { icon:makePOIIcon(p.color||'#ff3b30'), draggable:false }).addTo(poiLayer); markerIndex.set(p.id,m); m.bindPopup(makePopupHTML(p)); m.on('click',()=>{ if(editMode) openPointEditor(p.id); }); return m; }
    function makePopupHTML(p){ const title=p.title||'Uten navn'; const desc=p.desc||''; const cat=p.category||'ukjent'; return `<div style="min-width:180px"><strong>${escapeHTML(title)}</strong><br/><small>Kategori: ${escapeHTML(cat)}</small>${desc?`<p style=\"margin:6px 0 0\">${escapeHTML(desc)}</p>`:''}</div>`; }
    function escapeHTML(str=""){ const map={ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }; return String(str).replace(/[&<>"']/g, m=>map[m]); }

    // Redigering (punkter/ruter)
    let editMode=false; let addPointPending=false; const filtersEl=document.getElementById('filters'); let activeCats=new Set();
    function setEdit(on){ editMode=!!on; btnEdit.textContent = `✎ Rediger: ${editMode?'PÅ':'AV'}`; btnEdit.classList.toggle('primary', editMode); markerIndex.forEach(m=>{ if(m.dragging){ editMode?m.dragging.enable():m.dragging.disable(); } }); if(editMode){ if(!drawControlAdded){ map.addControl(drawControl); drawControlAdded=true; } } else { if(drawControlAdded){ map.removeControl(drawControl); drawControlAdded=false; } } }
    btnEdit.addEventListener('click', ()=>setEdit(!editMode));

    btnAddPoint.addEventListener('click', ()=>{ if(!editMode) setEdit(true); addPointPending=true; btnAddPoint.classList.add('primary'); btnAddPoint.textContent='Klikk i kartet…'; });
    btnRouteTool.addEventListener('click', ()=>{ if(!editMode) setEdit(true); alert('Velg linje‑verktøyet (venstre) for å tegne'); });

    map.on('click', (e)=>{ if(!addPointPending) return; addPointPending=false; btnAddPoint.classList.remove('primary'); btnAddPoint.textContent='＋ Punkt'; const p={ id:uid('p'), lat:e.latlng.lat, lng:e.latlng.lng, title:'Nytt punkt', desc:'', color:'#ff3b30', category:'' }; POIData.points.push(p); addMarkerToMap(p).openPopup(); openPointEditor(p.id); buildFilters(); });

    map.on(L.Draw.Event.CREATED, (evt)=>{ if(evt.layerType==='polyline'){ const layer=evt.layer; routeLayer.addLayer(layer); const r={ id:uid('r'), name:'Ny rute', color:'#0a7cff', coords:layer.getLatLngs().map(ll=>[ll.lat,ll.lng]) }; POIData.routes.push(r); routeIndex.set(r.id, layer); layer.setStyle({ color:r.color }); layer.on('click',()=>openRouteEditor(r.id)); openRouteEditor(r.id); } });
    map.on(L.Draw.Event.EDITED, (evt)=>{ evt.layers.eachLayer((layer)=>{ for(const [id,l] of routeIndex.entries()){ if(l===layer){ const r=POIData.routes.find(x=>x.id===id); if(r) r.coords=layer.getLatLngs().map(ll=>[ll.lat,ll.lng]); } } }); });
    map.on(L.Draw.Event.DELETED, (evt)=>{ evt.layers.eachLayer((layer)=>{ for(const [id,l] of routeIndex.entries()){ if(l===layer){ const i=POIData.routes.findIndex(x=>x.id===id); if(i>=0) POIData.routes.splice(i,1); routeIndex.delete(id); } } }); });

    function openPointEditor(id){ const p=POIData.points.find(x=>x.id===id); if(!p) return; panelTitle.textContent='Rediger punkt'; const cats=Array.from(new Set([ ...DEFAULT_CATEGORIES, ...POIData.points.map(pp=>(pp.category||'').trim()).filter(Boolean) ])).sort((a,b)=>a.localeCompare(b)); const opts=[ `<option value="" ${!p.category?'selected':''}>— Ingen —</option>`, ...cats.map(c=>`<option value="${escapeHTML(c)}" ${p.category===c?'selected':''}>${escapeHTML(c)}</option>`), `<option value="__new__">+ Ny kategori…</option>` ].join(''); panelBody.innerHTML=`<label>Tittel<input id="f_title" type="text" value="${p.title?escapeHTML(p.title):''}"></label><label>Beskrivelse<textarea id="f_desc">${p.desc?escapeHTML(p.desc):''}</textarea></label><div class="row"><label>Farge<input id="f_color" type="color" value="${p.color||'#ff3b30'}"></label><label>Kategori<select id="f_category">${opts}</select></label></div><label id="row_newcat" style="display:none;">Ny kategori<input id="f_category_new" type="text" placeholder="Skriv ny kategori"></label><div class="row"><label>Lat<input id="f_lat" type="text" value="${p.lat}"></label><label>Lng<input id="f_lng" type="text" value="${p.lng}"></label></div>`; const sel=panelBody.querySelector('#f_category'); const rowNew=panelBody.querySelector('#row_newcat'); sel.addEventListener('change',()=>{ rowNew.style.display = sel.value==='__new__' ? 'block':'none'; }); panel.classList.add('open'); currentEdit={ type:'point', id }; }
    function openRouteEditor(id){ const r=POIData.routes.find(x=>x.id===id); if(!r) return; panelTitle.textContent='Rediger rute'; panelBody.innerHTML=`<label>Navn<input id=\"r_name\" type=\"text\" value=\"${r.name?escapeHTML(r.name):''}\"></label><div class=\"row\"><label>Farge<input id=\"r_color\" type=\"color\" value=\"${r.color||'#0a7cff'}\"></label><label>Antall punkter<input type=\"text\" value=\"${(r.coords||[]).length}\" disabled></label></div>`; panel.classList.add('open'); currentEdit={ type:'route', id }; }

    let currentEdit={ type:null, id:null };
    btnApply.addEventListener('click', ()=>{ if(currentEdit.type==='point'){ const p=POIData.points.find(x=>x.id===currentEdit.id); if(!p) return; p.title = panelBody.querySelector('#f_title').value.trim(); p.desc = panelBody.querySelector('#f_desc').value.trim(); p.color = panelBody.querySelector('#f_color').value; const catSel = panelBody.querySelector('#f_category').value; p.category = (catSel==='__new__') ? panelBody.querySelector('#f_category_new').value.trim() : catSel.trim(); p.lat=parseFloat(panelBody.querySelector('#f_lat').value); p.lng=parseFloat(panelBody.querySelector('#f_lng').value); const m=markerIndex.get(p.id); if(m){ m.setLatLng([p.lat,p.lng]); m.setIcon(makePOIIcon(p.color||'#ff3b30')); m.setPopupContent(makePopupHTML(p)); } buildFilters(); } else if(currentEdit.type==='route'){ const r=POIData.routes.find(x=>x.id===currentEdit.id); if(!r) return; r.name=panelBody.querySelector('#r_name').value.trim(); r.color=panelBody.querySelector('#r_color').value; const line=routeIndex.get(r.id); if(line) line.setStyle({ color:r.color||'#0a7cff' }); } panel.classList.remove('open'); });
    btnDelete.addEventListener('click', ()=>{ if(!currentEdit.type) return; if(!confirm('Sikker på at du vil slette?')) return; if(currentEdit.type==='point'){ const i=POIData.points.findIndex(x=>x.id===currentEdit.id); if(i>=0) POIData.points.splice(i,1); const m=markerIndex.get(currentEdit.id); if(m){ poiLayer.removeLayer(m); markerIndex.delete(currentEdit.id); } } else if(currentEdit.type==='route'){ const i=POIData.routes.findIndex(x=>x.id===currentEdit.id); if(i>=0) POIData.routes.splice(i,1); const line=routeIndex.get(currentEdit.id); if(line){ routeLayer.removeLayer(line); routeIndex.delete(currentEdit.id); } } panel.classList.remove('open'); });
    btnClose.addEventListener('click', ()=>panel.classList.remove('open'));

    // Filter
    function buildFilters(){ const cats=Array.from(new Set([ ...DEFAULT_CATEGORIES, ...POIData.points.map(p=>(p.category||'').trim()).filter(Boolean) ])).sort((a,b)=>a.localeCompare(b)); filterChips.innerHTML=''; for(const c of cats){ const chip=document.createElement('span'); chip.className='chip'+(activeCats.has(c)?' active':''); chip.textContent=c; chip.addEventListener('click', ()=>{ if(activeCats.has(c)) activeCats.delete(c); else activeCats.add(c); chip.classList.toggle('active'); applyFilters(); }); filterChips.appendChild(chip); } }
    function applyFilters(){ const showAll=activeCats.size===0; POIData.points.forEach(p=>{ const m=markerIndex.get(p.id); if(!m) return; const visible = showAll || activeCats.has((p.category||'').trim()); if(visible) m.addTo(poiLayer); else poiLayer.removeLayer(m); }); }
    btnFilters.addEventListener('click', ()=> document.getElementById('filters').classList.toggle('open') );

    // Lagre POIs
    btnSave.addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(POIData,null,2)], { type:'application/json' }); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pois.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),2000); });

    // Last POIs til slutt
    loadPOIs();

    // Eksponer for rask feilsøk
    window.Kartvaaler = { map, POIData, WARP_CORNERS };
  </script>
</body>
</html>
