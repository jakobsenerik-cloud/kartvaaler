<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Turkart + OSM + LIVE GPS + POI (Redigeringsmodus)</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#eaf0f4}
  #ui{position:fixed;z-index:10;top:10px;left:10px;background:rgba(255,255,255,.95);
      padding:8px 10px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.12);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #ui input[type=search]{padding:6px 8px;border:1px solid #d0d7de;border-radius:8px;width:170px}
  #status{font-size:12px;color:#444}
  input[type=range]{width:120px}
  button{padding:6px 10px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer}
  #map{position:fixed;inset:0}
  #canvas{position:absolute;left:0;top:0;width:100%;height:100%;touch-action:none}
  /* GPS-markør */
  #marker{position:absolute; z-index:4; width:28px; height:28px; transform:translate(-14px,-26px); pointer-events:none}
  #marker svg{display:block}
  #accCircle{position:absolute; z-index:3; border:2px solid rgba(37,99,235,.6); background:rgba(37,99,235,.08); border-radius:50%; transform:translate(-50%,-50%); pointer-events:none}
  /* POI-lag */
  #poiLayer{position:absolute; inset:0; z-index:5; pointer-events:none}
  .poi-marker{position:absolute; width:24px; height:24px; transform:translate(-12px,-22px); pointer-events:auto; cursor:pointer}
  .poi-marker.editable{cursor:grab}
  .poi-marker.dragging{cursor:grabbing}
  .poi-marker svg{display:block}
  .poi-marker .lbl{position:absolute; left:14px; top:-2px; padding:2px 6px; background:rgba(255,255,255,.95); border:1px solid #e5e7eb; border-radius:6px; font-size:12px; white-space:nowrap; opacity:0; visibility:hidden; transform:translateX(6px); transition:opacity .15s ease, transform .15s ease;}
  .poi-marker:hover .lbl, .poi-marker:focus-within .lbl, .poi-marker.dragging .lbl{opacity:1; visibility:visible; transform:translateX(0);}
  /* POI-popup/editor */
  #poiPopup{position:absolute; z-index:6; max-width:320px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,.15); padding:10px; pointer-events:auto}
  #poiPopup h3{margin:0 0 6px;font-size:16px}
  #poiPopup p{margin:0 0 8px;font-size:14px}
  #poiPopup img{max-width:100%; border-radius:8px; display:block; margin:6px 0}
  #poiPopup .meta{font-size:12px;color:#555}
  #poiPopup .row{display:flex; gap:6px; margin:6px 0}
  #poiPopup input[type=text], #poiPopup input[type=url], #poiPopup textarea, #poiPopup input[type=color]{width:100%; padding:6px 8px; border:1px solid #d1d5db; border-radius:8px; font:14px system-ui}
  #poiPopup textarea{min-height:72px}
  #poiPopup label{font-size:12px; color:#374151}
  #poiPopup .actions{display:flex; gap:6px; margin-top:8px; flex-wrap:wrap}
  #poiPopup .close{position:absolute; right:8px; top:6px; border:0; background:transparent; font-size:18px; cursor:pointer}
  #poiPopup .danger{border-color:#ef4444;color:#b91c1c}
  /* Edit-bar */
  #editBar{display:none; align-items:center; gap:8px}
  #editBar input[type=file]{display:none}
  /* Attribution */
  #attrib{position:fixed;right:10px;bottom:8px;z-index:2;background:rgba(255,255,255,.9);
          padding:4px 6px;border-radius:6px;font:12px/1.2 system-ui}
  #attrib a{color:#0366d6;text-decoration:none}
</style>
</head>
<body>
  <div id="ui">
    <button id="fitBtn">Vis kartområdet</button>
    <label>Opasitet <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.95"></label>
    <button id="zoomIn">+</button>
    <button id="zoomOut">−</button>
    <button id="zoomFullOut">Zoom ut maks</button>
    <button id="centerMe">Sentrer meg</button>
    <button id="showPosition">Vis min posisjon</button>
    <button id="stopWatch">Stopp</button>
    <label>Farge dråpe <input id="gpsColor" type="color" value="#2563eb"></label>
    <input id="poiSearch" type="search" placeholder="Søk punkt…" />
    <label><input id="poiToggle" type="checkbox" checked> Vis punkter</label>
    <label><input id="editToggle" type="checkbox"> Rediger</label>
    <div id="editBar">
      <button id="addPoiBtn">Legg til punkt</button>
      <button id="exportBtn">Eksporter JSON</button>
      <button id="importBtn">Importer JSON</button><input id="importFile" type="file" accept="application/json"/>
      <button id="clearDraftBtn" title="Tøm lokal lagring (utkast)">Tøm utkast</button>
      <span id="editHint" style="font-size:12px;color:#555"></span>
    </div>
    <span id="status">Laster…</span>
  </div>

  <div id="map">
    <canvas id="canvas"></canvas>
    <div id="marker" hidden>
      <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
        <path id="gpsDropPath" d="M14 1 C8 1 4 5.5 4 10.5 c0 6.5 8 13 10 16 2-3 10-9.5 10-16 C24 5.5 20 1 14 1z" fill="#2563eb" stroke="white" stroke-width="2"/>
        <circle cx="14" cy="11" r="4" fill="white"/>
      </svg>
    </div>
    <div id="accCircle" hidden></div>

    <div id="poiLayer"></div>
    <div id="poiPopup" hidden>
      <button class="close" title="Lukk" aria-label="Lukk">×</button>
      <div class="content"></div>
    </div>
  </div>

  <div id="attrib">Kartgrunnlag: © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap-bidragsytere</a></div>

<script>
(function(){
  const IMAGE_URL = "Turkart.png?v=" + Date.now(); // cache-buster
  // Hjørner (WGS84) i rekkefølge: NW, NE, SE, SW
  const CORNERS = [
    [59.54593535667747, 10.765142440795898],
    [59.539561484456776, 11.201162338256838],
    [59.380786150970934, 11.190948486328127],
    [59.387167906588274, 10.756945610046387]
  ];
  // Zoom- og warp-innstillinger
  const MIN_SCALE = 0.01, MAX_SCALE = 8000;
  const GRID_FINE = {cols:24, rows:24};
  const GRID_FAST = {cols:8, rows:8};
  let currentGrid = GRID_FINE;
  const REFINE_DELAY = 140; // ms etter input-stopp før fin tegning

  const R = 6378137, TWO_PI_R = 2*Math.PI*R;

  const statusEl = document.getElementById('status');
  const setStatus = (m)=> statusEl.textContent = m;

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', {alpha:false});
  ctx.imageSmoothingEnabled = true; // slås av midlertidig under interaksjon
  const marker = document.getElementById('marker');
  const gpsDropPath = document.getElementById('gpsDropPath');
  const gpsColorInput = document.getElementById('gpsColor');
  const accCircle = document.getElementById('accCircle');
  const opacityInput = document.getElementById('opacity');

  const poiLayer = document.getElementById('poiLayer');
  const poiPopup = document.getElementById('poiPopup');
  const poiContent = poiPopup.querySelector('.content');
  const poiClose = poiPopup.querySelector('.close');
  const poiToggle = document.getElementById('poiToggle');
  const poiSearch = document.getElementById('poiSearch');

  const editToggle = document.getElementById('editToggle');
  const editBar = document.getElementById('editBar');
  const addPoiBtn = document.getElementById('addPoiBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');
  const clearDraftBtn = document.getElementById('clearDraftBtn');
  const editHint = document.getElementById('editHint');

  // Web Mercator
  const toRad = d => d*Math.PI/180;
  const mercXY = (lat, lng)=> { const x = R * toRad(lng); const y = R * Math.log(Math.tan(Math.PI/4 + toRad(lat)/2)); return {x,y}; };
  const invMercLL = (mx,my)=>{ const lng = (mx/R) * 180/Math.PI; const lat = (2*Math.atan(Math.exp(my/R)) - Math.PI/2) * 180/Math.PI; return {lat,lng}; };
  const cornersM  = CORNERS.map(([lat,lng])=>mercXY(lat,lng));

  let cssW=0, cssH=0;
  let center = {x:0, y:0};
  let scale = 1; // px per meter
  let img = new Image(), imgW=0, imgH=0;

  // ---- Render coalescing ----
  let rafId = null, refineTimer = null;
  function requestRender(){ if (rafId) return; rafId = requestAnimationFrame(()=>{ rafId = null; render(); }); }
  function enterFastMode(){ currentGrid = GRID_FAST; ctx.imageSmoothingEnabled = false; }
  function scheduleRefine(){ if (refineTimer) clearTimeout(refineTimer); refineTimer = setTimeout(()=>{ currentGrid = GRID_FINE; ctx.imageSmoothingEnabled = true; requestRender(); }, REFINE_DELAY); }

  function resize(){ const rect = canvas.getBoundingClientRect(); cssW = canvas.width = Math.round(rect.width); cssH = canvas.height= Math.round(rect.height); requestRender(); updatePOIPositions(); }
  new ResizeObserver(resize).observe(document.getElementById('map'));

  function fitView(){ const xs = cornersM.map(p=>p.x), ys = cornersM.map(p=>p.y); const minX=Math.min(...xs), maxX=Math.max(...xs); const minY=Math.min(...ys), maxY=Math.max(...ys); const pad = 0.08; const neededScaleX = (cssW*(1-pad*2)) / (maxX-minX); const neededScaleY = (cssH*(1-pad*2)) / (maxY-minY); scale = Math.min(neededScaleX, neededScaleY); center.x = (minX+maxX)/2; center.y = (minY+maxY)/2; requestRender(); updatePOIPositions(); }

  const worldToScreen = (mx,my)=>({ x: (mx - center.x)*scale + cssW/2, y: (center.y - my)*scale + cssH/2 });
  const screenToWorld = (sx,sy)=>({ mx: (sx - cssW/2)/scale + center.x, my: center.y - (sy - cssH/2)/scale });

  // --------- OSM tiles ----------
  const tileCache = new Map();
  const tileUrl = (z,x,y)=> `https://tile.openstreetmap.org/${z}/${x}/${y}.png`;
  function getTile(z,x,y){ const n = 1<<z; x = ((x % n) + n) % n; if (y<0 || y>=n) return null; const key = `${z}/${x}/${y}`; let im = tileCache.get(key); if (!im){ im = new Image(); im.crossOrigin = "anonymous"; im.src = tileUrl(z,x,y); im.onload = ()=>requestRender(); tileCache.set(key, im); } return im.complete ? im : null; }
  function mercToWorldPx(mx,my,z){ const S = 256 * (1<<z); const u = (mx + Math.PI*R) / TWO_PI_R; const v = (Math.PI*R - my) / TWO_PI_R; return { px: u*S, py: v*S }; }
  function drawOSM(){ let z = Math.round(Math.log2(scale * TWO_PI_R / 256)); z = Math.max(0, Math.min(19, z)); const S = 256 * (1<<z); const mpp = TWO_PI_R / S; const spw = scale * mpp; const c = mercToWorldPx(center.x, center.y, z); const halfW = cssW / spw / 2; const halfH = cssH / spw / 2; const minPx = c.px - halfW, maxPx = c.px + halfW; const minPy = c.py - halfH, maxPy = c.py + halfH; const minTx = Math.floor(minPx/256), maxTx = Math.floor(maxPx/256); const minTy = Math.floor(minPy/256), maxTy = Math.floor(maxPy/256); for (let ty=minTy; ty<=maxTy; ty++){ for (let tx=minTx; tx<=maxTx; tx++){ const im = getTile(z, tx, ty); if (!im) continue; const tilePx = tx*256, tilePy = ty*256; const sx = (tilePx - c.px)*spw + cssW/2; const sy = (tilePy - c.py)*spw + cssH/2; const s = 256*spw; ctx.drawImage(im, sx, sy, s, s); } } }

  // --------- Warp av Turkart ----------
  function setTriTransform(ctx, s0,s1,s2, d0,d1,d2){ const a11=s1.x-s0.x, a12=s2.x-s0.x, a21=s1.y-s0.y, a22=s2.y-s0.y; const det=a11*a22-a12*a21; if(Math.abs(det)<1e-12){ctx.setTransform(1,0,0,1,0,0);return;} const inv11=a22/det, inv12=-a12/det, inv13=-(inv11*s0.x+inv12*s0.y); const inv21=-a21/det, inv22=a11/det, inv23=-(inv21*s0.x+inv22*s0.y); const b11=d1.x-d0.x, b12=d2.x-d0.x, b13=d0.x; const b21=d1.y-d0.y, b22=d2.y-d0.y, b23=d0.y; const A=b11*inv11+b12*inv21, B=b21*inv11+b22*inv21; const C=b11*inv12+b12*inv22, D=b21*inv12+b22*inv22; const E=b11*inv13+b12*inv23+b13, F=b21*inv13+b22*inv23+b23; ctx.setTransform(A,B,C,D,E,F); }
  const lerp=(a,b,t)=>a+(b-a)*t; const lerpPt=(p,q,t)=>({x:lerp(p.x,q.x,t), y:lerp(p.y,q.y,t)});
  function quadOffscreen(q0,q1,q2,q3){ const minx = Math.min(q0.x,q1.x,q2.x,q3.x); const maxx = Math.max(q0.x,q1.x,q2.x,q3.x); const miny = Math.min(q0.y,q1.y,q2.y,q3.y); const maxy = Math.max(q0.y,q1.y,q2.y,q3.y); return (maxx < 0 || maxy < 0 || minx > cssW || miny > cssH); }
  function drawTurkart(){ if (!img.complete || !imgW) return; ctx.save(); ctx.globalAlpha = parseFloat(opacityInput.value||"0.95"); const pNW = worldToScreen(cornersM[0].x,cornersM[0].y); const pNE = worldToScreen(cornersM[1].x,cornersM[1].y); const pSE = worldToScreen(cornersM[2].x,cornersM[2].y); const pSW = worldToScreen(cornersM[3].x,cornersM[3].y); const COLS = currentGrid.cols, ROWS = currentGrid.rows; for(let j=0;j<ROWS;j++){ const v0=j/ROWS, v1=(j+1)/ROWS; const L0=lerpPt(pNW,pSW,v0), R0=lerpPt(pNE,pSE,v0); const L1=lerpPt(pNW,pSW,v1), R1=lerpPt(pNE,pSE,v1); for(let i=0;i<COLS;i++){ const u0=i/COLS, u1=(i+1)/COLS; const Q00=lerpPt(L0,R0,u0), Q10=lerpPt(L0,R0,u1); const Q01=lerpPt(L1,R1,u0), Q11=lerpPt(L1,R1,u1); if (quadOffscreen(Q00,Q10,Q11,Q01)) continue; const S00={x:u0*imgW,y:v0*imgH}, S10={x:u1*imgW,y:v0*imgH}; const S01={x:u0*imgW,y:v1*imgH}, S11={x:u1*imgW,y:v1*imgH}; ctx.save(); ctx.beginPath(); ctx.moveTo(Q00.x,Q00.y); ctx.lineTo(Q10.x,Q10.y); ctx.lineTo(Q11.x,Q11.y); ctx.closePath(); ctx.clip(); setTriTransform(ctx, S00,S10,S11, Q00,Q10,Q11); ctx.drawImage(img,0,0); ctx.restore(); ctx.save(); ctx.beginPath(); ctx.moveTo(Q00.x,Q00.y); ctx.lineTo(Q11.x,Q11.y); ctx.lineTo(Q01.x,Q01.y); ctx.closePath(); ctx.clip(); setTriTransform(ctx, S00,S11,S01, Q00,Q11,Q01); ctx.drawImage(img,0,0); ctx.restore(); } } ctx.restore(); }

  function render(){ ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,cssW,cssH); drawOSM(); drawTurkart(); if (lastPos){ const sp = worldToScreen(lastPos.mx,lastPos.my); marker.style.left = sp.x + 'px'; marker.style.top  = sp.y + 'px'; marker.hidden = false; if (lastPos.acc){ const pxR = lastPos.acc * scale; accCircle.style.width = (pxR*2)+'px'; accCircle.style.height= (pxR*2)+'px'; accCircle.style.left = sp.x + 'px'; accCircle.style.top  = sp.y + 'px'; accCircle.hidden = false; } } updatePOIPositions(); }

  // ---- Gestures: pan, pinch, dbl-tap IN, two-finger tap OUT ----
  let pointers = new Map(); let isPanning=false, panStartCenter=null, panStartPt=null; let pinchStartDist=0, pinchStartScale=1, pinchStartWorld=null, isPinching=false; let lastTapTime=0, lastTapPos=null, twoTapTimer=null; let draggingPoiId=null;

  canvas.addEventListener('pointerdown', e=>{ if (draggingPoiId) return; canvas.setPointerCapture(e.pointerId); pointers.set(e.pointerId, {x:e.clientX, y:e.clientY}); if (pointers.size===1){ isPanning = true; enterFastMode(); panStartCenter = {...center}; panStartPt = {x:e.clientX, y:e.clientY}; const now = performance.now(); const pos = {x:e.clientX, y:e.clientY}; if (now - lastTapTime < 300 && lastTapPos && Math.hypot(pos.x-lastTapPos.x, pos.y-lastTapPos.y) < 40){ const world = screenToWorld(pos.x, pos.y); scale = Math.min(MAX_SCALE, scale * 1.6); center.x = world.mx - (pos.x - cssW/2)/scale; center.y = (pos.y - cssH/2)/scale + world.my; requestRender(); lastTapTime = 0; lastTapPos = null; scheduleRefine(); } else { lastTapTime = now; lastTapPos = pos; } } else if (pointers.size===2){ isPinching = true; isPanning=false; enterFastMode(); const [p1,p2] = [...pointers.values()]; pinchStartDist = Math.hypot(p2.x-p1.x, p2.y-p1.y); pinchStartScale = scale; const mid = { x:(p1.x+p2.x)/2, y:(p1.y+p2.y)/2 }; pinchStartWorld = screenToWorld(mid.x, mid.y); const t = performance.now(); if (twoTapTimer && (t - twoTapTimer) < 280){ const world = pinchStartWorld; scale = Math.max(MIN_SCALE, scale / 1.6); center.x = world.mx - (mid.x - cssW/2)/scale; center.y = (mid.y - cssH/2)/scale + world.my; requestRender(); scheduleRefine(); twoTapTimer = null; } else { twoTapTimer = t; } } });
  canvas.addEventListener('pointermove', e=>{ if (!pointers.has(e.pointerId)) return; pointers.set(e.pointerId, {x:e.clientX, y:e.clientY}); if (isPinching && pointers.size>=2){ const [p1,p2] = [...pointers.values()].slice(0,2); const curDist = Math.hypot(p2.x-p1.x, p2.y-p1.y); if (pinchStartDist>0){ scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, pinchStartScale * (curDist/pinchStartDist))); } const mid = { x:(p1.x+p2.x)/2, y:(p1.y+p2.y)/2 }; center.x = pinchStartWorld.mx - (mid.x - cssW/2)/scale; center.y = (mid.y - cssH/2)/scale + pinchStartWorld.my; requestRender(); } else if (isPanning && pointers.size===1){ const p = pointers.get(e.pointerId); const dx = (p.x - panStartPt.x)/scale; const dy = (p.y - panStartPt.y)/scale; center.x = panStartCenter.x - dx; center.y = panStartCenter.y + dy; requestRender(); } });
  function endPointer(e){ pointers.delete(e.pointerId); if (pointers.size<2) isPinching=false; if (pointers.size===0){ isPanning=false; } scheduleRefine(); }
  canvas.addEventListener('pointerup', endPointer); canvas.addEventListener('pointercancel', endPointer); canvas.addEventListener('pointerout', endPointer); canvas.addEventListener('pointerleave', endPointer);
  canvas.addEventListener('wheel', e=>{ e.preventDefault(); enterFastMode(); const factor = Math.pow(1.0015, -e.deltaY); const pos = {x:e.clientX, y:e.clientY}; const world = screenToWorld(pos.x, pos.y); scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale * factor)); center.x = world.mx - (pos.x - cssW/2)/scale; center.y = (pos.y - cssH/2)/scale + world.my; requestRender(); scheduleRefine(); }, {passive:false});

  // ---- last bildet ----
  img.onload = ()=>{ imgW = img.naturalWidth; imgH = img.naturalHeight; resize(); fitView(); setStatus('Klar'); };
  img.onerror = ()=> setStatus('Klarte ikke å laste Turkart.png (må ligge i samme mappe som index.html)');
  img.src = IMAGE_URL;

  // ---- UI: knapper ----
  document.getElementById('fitBtn').onclick = fitView; opacityInput.oninput = ()=> requestRender();
  document.getElementById('zoomIn').onclick  = ()=>{ enterFastMode(); const p={x:cssW/2,y:cssH/2}; const w=screenToWorld(p.x,p.y); scale = Math.min(MAX_SCALE, scale * 1.3); center.x = w.mx - (p.x - cssW/2)/scale; center.y = (p.y - cssH/2)/scale + w.my; requestRender(); scheduleRefine(); };
  document.getElementById('zoomOut').onclick = ()=>{ enterFastMode(); const p={x:cssW/2,y:cssH/2}; const w=screenToWorld(p.x,p.y); scale = Math.max(MIN_SCALE, scale / 1.3); center.x = w.mx - (p.x - cssW/2)/scale; center.y = (p.y - cssH/2)/scale + w.my; requestRender(); scheduleRefine(); };
  document.getElementById('zoomFullOut').onclick = ()=>{ enterFastMode(); const p={x:cssW/2,y:cssH/2}; const w=screenToWorld(p.x,p.y); scale = MIN_SCALE; center.x = w.mx - (p.x - cssW/2)/scale; center.y = (p.y - cssH/2)/scale + w.my; requestRender(); scheduleRefine(); };

  // ---- GPS / dråpe ----
  let watchId=null, lastPos=null; const GPS_COLOR_DEFAULT = '#2563eb';
  function hexToRgb(hex){ hex=hex.replace('#',''); if (hex.length===3){ hex=hex.split('').map(c=>c+c).join(''); } const num=parseInt(hex,16); return {r:(num>>16)&255,g:(num>>8)&255,b:num&255}; }
  function setGpsColor(hex){ gpsDropPath.setAttribute('fill', hex); const {r,g,b}=hexToRgb(hex); accCircle.style.borderColor = `rgba(${r},${g},${b},0.65)`; accCircle.style.background  = `rgba(${r},${g},${b},0.10)`; }
  gpsColorInput.addEventListener('input', ()=> setGpsColor(gpsColorInput.value||GPS_COLOR_DEFAULT));
  setGpsColor(gpsColorInput.value||GPS_COLOR_DEFAULT);

  function updateMarker(lat,lng,acc){ const m=mercXY(lat,lng); lastPos = {mx:m.x,my:m.y,acc:acc||0}; requestRender(); }
  function startWatchPrecise(){ if (!navigator.geolocation){ setStatus('Geolocation ikke støttet'); return; } stopWatch(); const opts = { enableHighAccuracy:true, timeout:30000, maximumAge:0 }; marker.hidden = false; accCircle.hidden = false; setStatus('Sporer (presis)…'); watchId = navigator.geolocation.watchPosition( pos=>{ updateMarker(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy); setStatus(`Sporer: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)} (±${Math.round(pos.coords.accuracy)} m)`); }, err=>{ const code=({1:'PERMISSION_DENIED',2:'POSITION_UNAVAILABLE',3:'TIMEOUT'})[err.code]||'ERROR'; setStatus(`Sporing feilet: ${code} – ${err.message}`); }, opts ); }
  function stopWatch(){ if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } setStatus('Sporing stoppet'); }
  async function centerOnMe(){ if (lastPos){ center.x = lastPos.mx; center.y = lastPos.my; requestRender(); scheduleRefine(); return; } if (!navigator.geolocation){ setStatus('Geolocation ikke støttet'); return; } setStatus('Henter posisjon…'); navigator.geolocation.getCurrentPosition( pos => { updateMarker(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy); center.x = lastPos.mx; center.y = lastPos.my; requestRender(); scheduleRefine(); setStatus(`Posisjon: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)} (±${Math.round(pos.coords.accuracy)} m)`); }, err => { const code=({1:'PERMISSION_DENIED',2:'POSITION_UNAVAILABLE',3:'TIMEOUT'})[err.code]||'ERROR'; setStatus(`Kunne ikke hente posisjon: ${code} – ${err.message}`); }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 } ); }
  document.getElementById('centerMe').onclick     = centerOnMe; document.getElementById('showPosition').onclick = startWatchPrecise; document.getElementById('stopWatch').onclick    = stopWatch;

  // ---- POI: data + rendering ----
  let POIS = [
    {"id":"p1","title":"Gapahuk","lat":59.4685,"lng":10.9365,"category":"turmål","desc":"Enkel gapahuk med bålplass. Fint utsiktspunkt."},
    {"id":"p3","title":"Utsiktspunkt","lat":59.4568,"lng":10.9582,"category":"turmål","desc":"Utsikt over vika.","link":"https://example.com/utsikt"},
    {"id":"p1757705205324","title":"Nytt punkt","lat":59.475191699914554,"lng":10.83445462414308,"category":"","desc":"","color":"#fa2b79","link":"","image":""},
    {"id":"p1757705352342","title":"Augerød boligfelt","lat":59.466042955055755,"lng":10.783598381158985,"category":"Interessepunkt","desc":"","color":"#fb2677","link":"","image":""},
    {"id":"p1757705516687","title":"Augerødmosan Torvuttak","lat":59.46442060111445,"lng":10.792418909883002,"category":"Interessepunkt","desc":"","color":"#fa2977","link":"","image":""},
    {"id":"p1757705850094","title":"Rød hyttefelt","lat":59.46039457453535,"lng":10.76963573454026,"category":"Interessepunkt","desc":"","color":"#fc2b7d","link":"","image":""},
    {"id":"p1757705972716","title":"Jettegryte","lat":59.43676138276811,"lng":10.79490222510431,"category":"Interessepunkt","desc":"","color":"#fa2b7c","link":"","image":""},
    {"id":"p1757706035158","title":"Sønsterød hyttefelt","lat":59.43766825805131,"lng":10.786234718342879,"category":"Interessepunkt","desc":"","color":"#fa2b7c","link":"","image":""},
    {"id":"p1757706137384","title":"Bergeråsen bygdeborg","lat":59.45982971653824,"lng":10.806960142985895,"category":"Interessepunkt","desc":"","color":"#fa2b79","link":"https://vaaler-of.frivilligsentral.no/irisfile/161185/berg%C3%A5sen-bygdeborg-endelig-utg-180609pdf.pdf","image":""},
    {"id":"p1757706217412","title":"Våk barneskole","lat":59.46298259975104,"lng":10.798153505553058,"category":"Interessepunkt","desc":"","color":"#f97316","link":"http://www.vaak.gs.of.no/","image":""},
    {"id":"p1757706388440","title":"Texnes boligfelt","lat":59.45950321197825,"lng":10.792823418737889,"category":"Interessepunkt","desc":"","color":"#fb2c7a","link":"","image":""}
  ];
  fetch('pois.json', {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error('ingen'); return r.json(); }).then(json=>{ if(Array.isArray(json)) POIS = json; buildPOIMarkers(); updatePOIPositions(); loadDraftIfAny(); }).catch(()=>{ buildPOIMarkers(); updatePOIPositions(); loadDraftIfAny(); });

  const poiElems = new Map(); // id -> DOM element
  function colorForCategory(cat){ return cat==='parkering' ? '#0ea5e9' : cat==='turmål' ? '#22c55e' : '#f97316'; }
  function colorForPOI(p){ return p.color || colorForCategory(p.category||'poi'); }
  function iconForPOI(p){ const color = colorForPOI(p); return `<svg width="24" height="24" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><path d=\"M14 1 C8 1 4 5.5 4 10.5 c0 6.5 8 13 10 16 2-3 10-9.5 10-16 C24 5.5 20 1 14 1z\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/><circle cx=\"14\" cy=\"11\" r=\"3.5\" fill=\"white\"/></svg>`; }

  function buildPOIMarkers(){ poiLayer.innerHTML=''; poiElems.clear(); for (const p of POIS){ const el = document.createElement('div'); el.className = 'poi-marker'; el.dataset.id = p.id; el.innerHTML = iconForPOI(p) + (p.title?`<span class=\"lbl\">${escapeHtml(p.title)}</span>`:''); el.addEventListener('click', (e)=>{ e.stopPropagation(); if (editMode) openPOIEditor(p, el._lastPos||{x:cssW/2,y:cssH/2}); else openPOIPopup(p, el._lastPos||{x:cssW/2,y:cssH/2}); }); enableDragIfEdit(el, p); enableLongPressDelete(el, p); poiLayer.appendChild(el); poiElems.set(p.id, el); } }

  function updatePOIPositions(){ const show = poiToggle.checked; const q = (poiSearch.value||'').trim().toLowerCase(); for (const p of POIS){ const el = poiElems.get(p.id); if (!el) continue; if (!show){ el.style.display='none'; continue; } const hit = !q || (p.title&&p.title.toLowerCase().includes(q)) || (p.desc&&p.desc.toLowerCase().includes(q)) || (p.category&&p.category.toLowerCase().includes(q)); if (!hit){ el.style.display='none'; continue; } const m = mercXY(p.lat, p.lng); const s = worldToScreen(m.x, m.y); el.style.left = s.x+'px'; el.style.top  = s.y+'px'; el.style.display = (s.x<-50||s.y<-50||s.x>cssW+50||s.y>cssH+50) ? 'none' : 'block'; el._lastPos = s; } }

  function openPOIPopup(p, screenPt){ const parts = []; parts.push(`<h3>${escapeHtml(p.title||'Punkt')}</h3>`); if (p.image) parts.push(`<img src="${encodeURI(p.image)}" alt="">`); if (p.desc) parts.push(`<p>${escapeHtml(p.desc)}</p>`); const meta = [`Kategori: ${escapeHtml(p.category||'—')}`, `Lat/Lng: ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`]; if (p.link) meta.push(`<a href="${escapeURITrusted(p.link)}" target="_blank" rel="noopener">Mer info ↗</a>`); parts.push(`<div class="meta">${meta.join(' · ')}</div>`); if (editMode) parts.push(`<div class="actions"><button id="popupEdit">Rediger</button><button id="popupDelete" class="danger">Slett</button></div>`); poiContent.innerHTML = parts.join(''); poiPopup.hidden = false; positionPopupNear(screenPt); if (editMode){ poiContent.querySelector('#popupEdit').onclick=()=> openPOIEditor(p, screenPt); poiContent.querySelector('#popupDelete').onclick=()=> deletePOI(p); } }

  function openPOIEditor(p, screenPt){ const cats = ['turmål','parkering','vann','annen']; const colorVal = colorForPOI(p); poiContent.innerHTML = `
    <h3>Rediger punkt</h3>
    <div class="row"><label>Tittel<br><input id="e_title" type="text" value="${escapeAttr(p.title||'')}"></label></div>
    <div class="row"><label>Kategori<br><input id="e_category" list="catlist" type="text" value="${escapeAttr(p.category||'')}"></label></div>
    <div class="row"><label>Farge<br><input id="e_color" type="color" value="${escapeAttr(colorVal)}"></label></div>
    <div class="row"><label>Beskrivelse<br><textarea id="e_desc">${escapeHtml(p.desc||'')}</textarea></label></div>
    <div class="row"><label>Lenke (URL)<br><input id="e_link" type="url" value="${escapeAttr(p.link||'')}"></label></div>
    <div class="row"><label>Bilde (URL)<br><input id="e_image" type="url" value="${escapeAttr(p.image||'')}"></label></div>
    <div class="row"><label>Lat<br><input id="e_lat" type="text" value="${p.lat}"></label><label>Lng<br><input id="e_lng" type="text" value="${p.lng}"></label></div>
    <div class="actions">
      <button id="e_save">Lagre</button>
      <button id="e_center">Sentrer på punkt</button>
      <button id="e_myloc">Sett til min posisjon</button>
      <button id="e_delete" class="danger">Slett</button>
    </div>
    <datalist id="catlist">${cats.map(c=>`<option value="${c}">`).join('')}</datalist>
  `; poiPopup.hidden = false; positionPopupNear(screenPt);
    poiContent.querySelector('#e_save').onclick = ()=>{ p.title=val('#e_title'); p.category=val('#e_category'); p.color=val('#e_color')||undefined; p.desc=val('#e_desc'); p.link=val('#e_link'); p.image=val('#e_image'); p.lat=parseFloat(val('#e_lat')); p.lng=parseFloat(val('#e_lng')); commitPOIChange(); buildPOIMarkers(); updatePOIPositions(); openPOIEditor(p, poiElems.get(p.id)._lastPos); };
    poiContent.querySelector('#e_center').onclick = ()=>{ const m=mercXY(p.lat,p.lng); center.x=m.x; center.y=m.y; requestRender(); scheduleRefine(); positionPopupNear(poiElems.get(p.id)._lastPos); };
    poiContent.querySelector('#e_myloc').onclick = ()=>{ if (!lastPos){ setStatus('Ingen GPS-posisjon ennå'); return; } const ll = invMercLL(lastPos.mx,lastPos.my); p.lat=ll.lat; p.lng=ll.lng; commitPOIChange(); updatePOIPositions(); openPOIEditor(p, poiElems.get(p.id)._lastPos); };
    poiContent.querySelector('#e_delete').onclick = ()=> deletePOI(p);
  }

  function deletePOI(p){ if (confirm('Slette punkt "'+(p.title||p.id)+'"?')){ POIS = POIS.filter(x=>x.id!==p.id); commitPOIChange(); buildPOIMarkers(); updatePOIPositions(); closePOIPopup(); } }

  function val(sel){ return poiContent.querySelector(sel).value.trim(); }
  function closePOIPopup(){ poiPopup.hidden = true; }
  function positionPopupNear(pt){ const pad=8; const w=320; const h=240; let x = pt.x + 14, y = pt.y - h - 16; if (y < 10) y = pt.y + 18; if (x + w > cssW - 10) x = cssW - w - 10; if (x < 10) x = 10; poiPopup.style.left = Math.round(x)+'px'; poiPopup.style.top  = Math.round(y)+'px'; }
  poiClose.addEventListener('click', closePOIPopup); document.addEventListener('keydown', e=>{ if(e.key==='Escape') closePOIPopup(); }); canvas.addEventListener('click', ()=> closePOIPopup());

  poiToggle.addEventListener('change', ()=>{ updatePOIPositions(); closePOIPopup(); }); poiSearch.addEventListener('input', ()=>{ updatePOIPositions(); });

  // ---- Edit mode ----
  let editMode = false, addingMode = false;
  editToggle.addEventListener('change', ()=> setEditMode(editToggle.checked));
  function setEditMode(on){ editMode = on; editBar.style.display = on ? 'inline-flex' : 'none'; editHint.textContent = on ? 'Tips: dra markører for å flytte, klikk for å redigere. Hold inne (0,7 s) for å slette.' : ''; for (const [id,el] of poiElems){ el.classList.toggle('editable', on); } addingMode = false; addPoiBtn.textContent = 'Legg til punkt'; }

  addPoiBtn.addEventListener('click', ()=>{ addingMode = !addingMode; addPoiBtn.textContent = addingMode ? 'Klikk i kartet… (avbryt)' : 'Legg til punkt'; editHint.textContent = addingMode ? 'Trykk i kartet der punktet skal ligge' : ' '; });
  canvas.addEventListener('click', e=>{ if (!editMode || !addingMode) return; const rect = canvas.getBoundingClientRect(); const sx = e.clientX - rect.left, sy = e.clientY - rect.top; const w = screenToWorld(sx, sy); const ll = invMercLL(w.mx, w.my); const id = 'p'+Date.now(); const p = { id, title:'Nytt punkt', lat:ll.lat, lng:ll.lng, category:'', desc:'' }; POIS.push(p); commitPOIChange(); buildPOIMarkers(); updatePOIPositions(); addingMode=false; addPoiBtn.textContent='Legg til punkt'; openPOIEditor(p, poiElems.get(p.id)._lastPos); });

  function enableDragIfEdit(el, p){ let dragging=false, moveHandler=null, upHandler=null, downX=0, downY=0; el.addEventListener('pointerdown', (ev)=>{ if (!editMode) return; ev.preventDefault(); ev.stopPropagation(); dragging=true; draggingPoiId=p.id; el.classList.add('dragging'); downX=ev.clientX; downY=ev.clientY; moveHandler = (e)=>{ const rect = canvas.getBoundingClientRect(); const sx = e.clientX - rect.left, sy = e.clientY - rect.top; const w = screenToWorld(sx, sy); const ll = invMercLL(w.mx, w.my); p.lat = ll.lat; p.lng = ll.lng; updatePOIPositions(); }; upHandler = (e)=>{ dragging=false; draggingPoiId=null; el.classList.remove('dragging'); commitPOIChange(); window.removeEventListener('pointermove', moveHandler); window.removeEventListener('pointerup', upHandler); }; window.addEventListener('pointermove', moveHandler); window.addEventListener('pointerup', upHandler); }); }

  function enableLongPressDelete(el, p){ let timer=null; const start=(ev)=>{ if(!editMode) return; timer=setTimeout(()=>{ timer=null; deletePOI(p); },700); }; const cancel=()=>{ if(timer){ clearTimeout(timer); timer=null; } }; el.addEventListener('pointerdown', start); el.addEventListener('pointerup', cancel); el.addEventListener('pointercancel', cancel); el.addEventListener('pointerleave', cancel); el.addEventListener('pointermove', cancel); }

  // ---- Persistens: lokal utkast + import/eksport ----
  const DRAFT_KEY = 'pois-draft-v1';
  function commitPOIChange(){ try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(POIS)); }catch{} buildPOIMarkers(); updatePOIPositions(); }
  function loadDraftIfAny(){ try{ const raw = localStorage.getItem(DRAFT_KEY); if (raw){ const arr = JSON.parse(raw); if (Array.isArray(arr)){ POIS = arr; setStatus('POI: lastet utkast fra denne enheten'); buildPOIMarkers(); updatePOIPositions(); } } }catch{} }
  exportBtn.addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(POIS,null,2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pois.json'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove(); setStatus('Lastet ned pois.json'); });
  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', ()=>{ const f = importFile.files[0]; if (!f) return; const reader = new FileReader(); reader.onload = ()=>{ try{ const arr = JSON.parse(reader.result); if (!Array.isArray(arr)) throw new Error('Array forventet'); for (const o of arr){ if (typeof o.lat!=='number'||typeof o.lng!=='number') throw new Error('lat/lng mangler'); if (!o.id) o.id = 'p'+Math.random().toString(36).slice(2); } POIS = arr; commitPOIChange(); setStatus('Importert '+arr.length+' punkter'); }catch(err){ alert('Klarte ikke å importere: '+err.message); } }; reader.readAsText(f); importFile.value=''; });
  clearDraftBtn.addEventListener('click', ()=>{ if (confirm('Tømme lokalt utkast? (påvirker ikke pois.json i repo)')){ localStorage.removeItem(DRAFT_KEY); setStatus('Utkast tømt'); } });

  // hjelpefunksjoner
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }
  function escapeURITrusted(u){ try{ const url=new URL(u, location.href); return url.href; }catch{ return '#'; } }

  // init
  buildPOIMarkers();

})();
</script>
</body>
</html>
