<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Kartvaaler – Rollback (Leaflet classic, stabil)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<style>
  html, body { height: 100%; margin: 0; background:#eaf0f4; }
  #map { position: absolute; inset: 0; }
  #ui { position: absolute; z-index: 1000; top: 10px; left: 10px; background: rgba(255,255,255,.95); padding: 8px 10px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,.12); font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  #ui label { display:flex; align-items:center; gap:6px }
  #status { font-size: 12px; color:#334155 }
  #ver { font-size:12px; color:#0f172a; background:#e2e8f0; border-radius:6px; padding:2px 6px }
  input[type=range]{ width:120px }
  button{ padding:6px 10px; border:1px solid #d0d7de; border-radius:8px; background:#fff; cursor:pointer }
  .leaflet-container { background:#e8eef2; }
  /* GPS-stil */
  .gps-drop { width:28px; height:28px; transform: translate(-14px,-26px); }
  .gps-acc { color:#2563eb; }
  /* Canvas warp pane */
  .warp-pane canvas { position:absolute; left:0; top:0; }
</style>
</head>
<body>
  <div id="map"></div>
  <div id="ui">
    <button id="fitBtn">Vis kartområdet</button>
    <label>Opasitet <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.95"></label>
    <button id="centerMe">Sentrer meg</button>
    <button id="startPrecise">Vis min posisjon</button>
    <button id="stopWatch">Stopp</button>
    <span id="status">Laster…</span>
    <span id="ver"></span>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function(){
  const VERSION='rollback-classic ' + new Date().toISOString().slice(0,16).replace('T',' ');
  const statusEl=document.getElementById('status');
  const setStatus=(m)=> statusEl.textContent=m;
  document.getElementById('ver').textContent=VERSION;
  window.addEventListener('error', e=> setStatus('JS-feil: '+(e.message||'ukjent')));
  window.addEventListener('unhandledrejection', e=>{const r=e.reason||{}; setStatus('Promise-feil: '+(r.message||r));});

  // --- konfig ---
  const IMAGE_URL='Turkart.png?v='+Date.now();
  // Hjørner i rekkefølge: NW, NE, SE, SW (WGS84 / lat,lng)
  const CORNERS=[
    [59.54593535667747, 10.765142440795898],
    [59.539561484456776, 11.201162338256838],
    [59.380786150970934, 11.190948486328127],
    [59.387167906588274, 10.756945610046387]
  ];

  // --- Leaflet-basiskart ---
  const map=L.map('map', { zoomControl:true, zoomAnimation:true, fadeAnimation:true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap-bidragsytere'
  }).addTo(map);

  // --- egendefinert canvas-warp layer oppå overlayPane ---
  const warpPane=map.createPane('warp');
  warpPane.classList.add('warp-pane');
  const canvas=document.createElement('canvas');
  const ctx=canvas.getContext('2d');
  warpPane.appendChild(canvas);
  let img=new Image(); let imgW=0, imgH=0; img.onload=()=>{ imgW=img.naturalWidth; imgH=img.naturalHeight; renderWarp(); setStatus('Klar'); }; img.onerror=()=> setStatus('Klarte ikke å laste Turkart.png'); img.src=IMAGE_URL;

  const toPt=(latlng)=> map.latLngToLayerPoint(latlng);
  const CORNERS_LL=CORNERS.map(([lat,lng])=>L.latLng(lat,lng));
  const bounds=L.latLngBounds(CORNERS_LL);
  function fitView(){ map.fitBounds(bounds, { padding:[10,10] }); }
  document.getElementById('fitBtn').onclick=fitView;

  function resizeCanvas(){ const sz=map.getSize(); canvas.width=sz.x; canvas.height=sz.y; const pos=map.containerPointToLayerPoint([0,0]); L.DomUtil.setPosition(canvas, pos); }
  function setTriTransform(ctx,s0,s1,s2,d0,d1,d2){
    const a11=s1.x-s0.x,a12=s2.x-s0.x,a21=s1.y-s0.y,a22=s2.y-s0.y; const det=a11*a22-a12*a21; if(Math.abs(det)<1e-12){ ctx.setTransform(1,0,0,1,0,0); return; }
    const inv11=a22/det, inv12=-a12/det, inv13=-(inv11*s0.x+inv12*s0.y);
    const inv21=-a21/det, inv22=a11/det, inv23=-(inv21*s0.x+inv22*s0.y);
    const b11=d1.x-d0.x, b12=d2.x-d0.x, b13=d0.x;
    const b21=d1.y-d0.y, b22=d2.y-d0.y, b23=d0.y;
    const A=b11*inv11+b12*inv21, B=b21*inv11+b22*inv21;
    const C=b11*inv12+b12*inv22, D=b21*inv12+b22*inv22;
    const E=b11*inv13+b12*inv23+b13, F=b21*inv13+b22*inv23+b23;
    ctx.setTransform(A,B,C,D,E,F);
  }
  const lerp=(a,b,t)=> a+(b-a)*t;
  const lerpPt=(p,q,t)=> ({x:lerp(p.x,q.x,t), y:lerp(p.y,q.y,t)});

  const opacity=document.getElementById('opacity');
  opacity.addEventListener('input', ()=> renderWarp());

  function renderWarp(){ if(!imgW||!imgH) return; resizeCanvas(); ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.globalAlpha=parseFloat(opacity.value||'0.95');
    const [NW,NE,SE,SW]=CORNERS_LL.map(ll=>toPt(ll));
    const COLS=20, ROWS=20; // stabilt og pen kvalitet
    for(let j=0;j<ROWS;j++){
      const v0=j/ROWS, v1=(j+1)/ROWS;
      const L0=lerpPt(NW,SW,v0), R0=lerpPt(NE,SE,v0);
      const L1=lerpPt(NW,SW,v1), R1=lerpPt(NE,SE,v1);
      for(let i=0;i<COLS;i++){
        const u0=i/COLS, u1=(i+1)/COLS;
        const Q00=lerpPt(L0,R0,u0), Q10=lerpPt(L0,R0,u1);
        const Q01=lerpPt(L1,R1,u0), Q11=lerpPt(L1,R1,u1);
        // tri 1: 00-10-11
        ctx.save(); ctx.beginPath(); ctx.moveTo(Q00.x,Q00.y); ctx.lineTo(Q10.x,Q10.y); ctx.lineTo(Q11.x,Q11.y); ctx.closePath(); ctx.clip();
        const S00={x:u0*imgW, y:v0*imgH}, S10={x:u1*imgW, y:v0*imgH}, S11={x:u1*imgW, y:v1*imgH};
        setTriTransform(ctx,S00,S10,S11,Q00,Q10,Q11);
        ctx.drawImage(img,0,0);
        ctx.restore();
        // tri 2: 00-11-01
        ctx.save(); ctx.beginPath(); ctx.moveTo(Q00.x,Q00.y); ctx.lineTo(Q11.x,Q11.y); ctx.lineTo(Q01.x,Q01.y); ctx.closePath(); ctx.clip();
        const S01={x:u0*imgW, y:v1*imgH};
        setTriTransform(ctx,S00,S11,S01,Q00,Q11,Q01);
        ctx.drawImage(img,0,0);
        ctx.restore();
      }
    }
    ctx.restore();
  }

  map.on('move zoom resize', renderWarp);
  // start synlig utsnitt
  fitView();

  // --- GPS med Leaflet ---
  const dropIcon=L.divIcon({ className:'', html:`<svg class="gps-drop" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><path d="M14 1 C8 1 4 5.5 4 10.5 c0 6.5 8 13 10 16 2-3 10-9.5 10-16 C24 5.5 20 1 14 1z" fill="#2563eb" stroke="white" stroke-width="2"/><circle cx="14" cy="11" r="4" fill="white"/></svg>` });
  let userMarker=null, accCircle=null, watchId=null;
  function showUser(lat,lng,acc){ const ll=L.latLng(lat,lng); if(!userMarker){ userMarker=L.marker(ll,{icon:dropIcon}).addTo(map); } else userMarker.setLatLng(ll);
    if(!accCircle){ accCircle=L.circle(ll,{ radius:acc||0, className:'gps-acc', color:'#2563eb', weight:1, fillOpacity:0.08 }).addTo(map); }
    accCircle.setLatLng(ll); if(acc!=null) accCircle.setRadius(acc);
  }
  function startPrecise(){ if(!navigator.geolocation){ setStatus('Geolocation ikke støttet'); return; } stopWatch(); setStatus('Sporer (presis)…'); watchId=navigator.geolocation.watchPosition(pos=>{
      showUser(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy);
      setStatus(`Sporer: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)} (±${Math.round(pos.coords.accuracy)} m)`);
    }, err=>{ const code=({1:'PERMISSION_DENIED',2:'POSITION_UNAVAILABLE',3:'TIMEOUT'})[err.code]||'ERROR'; setStatus(`Sporing feilet: ${code} – ${err.message}`); }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 }); }
  function centerMe(){ if(userMarker){ map.panTo(userMarker.getLatLng()); return; } if(!navigator.geolocation){ setStatus('Geolocation ikke støttet'); return; } setStatus('Henter posisjon…'); navigator.geolocation.getCurrentPosition(pos=>{ showUser(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy); map.setView([pos.coords.latitude,pos.coords.longitude], map.getZoom()); setStatus(`Posisjon: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)} (±${Math.round(pos.coords.accuracy)} m)`); }, err=>{ const code=({1:'PERMISSION_DENIED',2:'POSITION_UNAVAILABLE',3:'TIMEOUT'})[err.code]||'ERROR'; setStatus(`Kunne ikke hente posisjon: ${code} – ${err.message}`); }, { enableHighAccuracy:false, timeout:8000, maximumAge:120000 }); }
  function stopWatch(){ if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; setStatus('Sporing stoppet'); } }
  document.getElementById('startPrecise').onclick=startPrecise;
  document.getElementById('centerMe').onclick=centerMe;
  document.getElementById('stopWatch').onclick=stopWatch;

})();
</script>
</body>
</html>
