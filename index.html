<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Kartvaaler – Rollback + POI (Leaflet classic, stabil)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<style>
  html, body { height: 100%; margin: 0; background:#eaf0f4; }
  #map { position: absolute; inset: 0; }
  #ui { position: absolute; z-index: 1000; top: 10px; left: 10px; background: rgba(255,255,255,.95); padding: 8px 10px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,.12); font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  #ui label { display:flex; align-items:center; gap:6px }
  #status { font-size: 12px; color:#334155 }
  #ver { font-size:12px; color:#0f172a; background:#e2e8f0; border-radius:6px; padding:2px 6px }
  input[type=range]{ width:120px }
  button{ padding:6px 10px; border:1px solid #d0d7de; border-radius:8px; background:#fff; cursor:pointer }
  .leaflet-container { background:#e8eef2; }
  /* GPS-stil */
  .gps-drop { width:28px; height:28px; transform: translate(-14px,-26px); }
  .gps-acc { color:#2563eb; }
  /* Canvas warp pane */
  .warp-pane canvas { position:absolute; left:0; top:0; }
  /* POI */
  .poi-icon svg { display:block }
  .leaflet-tooltip.mytooltip { background:rgba(255,255,255,.95); border:1px solid #e5e7eb; color:#111827; border-radius:6px; box-shadow:0 6px 16px rgba(0,0,0,.12); }
  .leaflet-tooltip.mytooltip::before { border-top-color:#e5e7eb; }
</style>
</head>
<body>
  <div id="map"></div>
  <div id="ui">
    <button id="fitBtn">Vis kartområdet</button>
    <label>Opasitet <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.95"></label>
    <button id="centerMe">Sentrer meg</button>
    <button id="startPrecise">Vis min posisjon</button>
    <button id="stopWatch">Stopp</button>
    <label><input id="poiToggle" type="checkbox" checked> Vis punkter</label>
    <span id="status">Laster…</span>
    <span id="ver"></span>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function(){
  const VERSION='rollback+poi ' + new Date().toISOString().slice(0,16).replace('T',' ');
  const statusEl=document.getElementById('status');
  const setStatus=(m)=> statusEl.textContent=m;
  document.getElementById('ver').textContent=VERSION;
  window.addEventListener('error', e=> setStatus('JS-feil: '+(e.message||'ukjent')));
  window.addEventListener('unhandledrejection', e=>{const r=e.reason||{}; setStatus('Promise-feil: '+(r.message||r));});

  // --- data (innebygd) ---
  const POIS = [{"id":"p1","title":"Gapahuk","lat":59.4685,"lng":10.9365,"category":"turmål","desc":"Enkel gapahuk med bålplass. Fint utsiktspunkt."},{"id":"p3","title":"Utsiktspunkt","lat":59.4568,"lng":10.9582,"category":"turmål","desc":"Utsikt over vika.","link":"https://example.com/utsikt"},{"id":"p1757705205324","title":"Nytt punkt","lat":59.475191699914554,"lng":10.974123372893677,"category":"","desc":""},{"id":"p1757705209018","title":"Nytt punkt","lat":59.464434,"lng":10.779567,"category":"","desc":""},{"id":"p1757705393758","title":"Nytt punkt","lat":59.46425311365443,"lng":10.780044905755304,"category":"","desc":""},{"id":"p1757754978541","title":"Lars varde","lat":59.465738559796485,"lng":10.980573311753572,"category":"Utsiktspunkt","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757754991386","title":"Spiralen","lat":59.46560788701329,"lng":10.980699698533066,"category":"Utsiktspunkt","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757755094777","title":"Varde","lat":59.46574055119602,"lng":10.980508399980014,"category":"Utsiktspunkt","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757755706071","title":"Turmål","lat":59.45796664569131,"lng":10.844839476960254,"category":"Turmål","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757763703597","title":"Sted","lat":59.50272161077502,"lng":10.840388821115905,"category":"Interessepunkt","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803651199","title":"F barely","lat":59.49219792699634,"lng":10.838976231629495,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803662567","title":"F grønt","lat":59.4939828659889,"lng":10.839685984143733,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803674158","title":"F ok","lat":59.49394675748732,"lng":10.839107049096222,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803686330","title":"F tett","lat":59.49416571657343,"lng":10.838912360015826,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803738639","title":"T","lat":59.49449896401655,"lng":10.838124692576314,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803746330","title":"T","lat":59.494731630930745,"lng":10.838266610579192,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803753887","title":"T","lat":59.4948756955999,"lng":10.83837658605695,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803775617","title":"S","lat":59.494874865548334,"lng":10.838396317037167,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803787076","title":"S","lat":59.49491570785487,"lng":10.838465800706333,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803802391","title":"S","lat":59.49510130678607,"lng":10.838581120787333,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803821704","title":"L","lat":59.49520417708529,"lng":10.838661456906628,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803831329","title":"L","lat":59.49528058799907,"lng":10.838639048019827,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803839937","title":"L","lat":59.49527620693099,"lng":10.838584994931408,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803851300","title":"V","lat":59.49533627977876,"lng":10.838726650128222,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803864277","title":"V","lat":59.49537625730549,"lng":10.838805258100573,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803873810","title":"V","lat":59.4954843116579,"lng":10.838849087934947,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803884513","title":"E","lat":59.49557686111718,"lng":10.83885568490696,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803896153","title":"E","lat":59.495674727687516,"lng":10.838865407602263,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803906118","title":"E","lat":59.49577709008719,"lng":10.838896679165275,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803916879","title":"R","lat":59.49588095764758,"lng":10.838911729496879,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803926749","title":"R","lat":59.4960160757456,"lng":10.838920976277018,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803936590","title":"R","lat":59.49612014622746,"lng":10.838951908954665,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803947130","title":"Dessverre","lat":59.496170857291625,"lng":10.838974954649701,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757803959392","title":"Dessverre","lat":59.49627057984746,"lng":10.838987842953144,"category":"","desc":"","color":"#09ff05","link":"","image":""},{"id":"p1757833386043","title":"Turforslag: Svarttjern rundt","lat":59.4639,"lng":10.9807,"category":"Turforslag","desc":"En kort og fin runde rundt vannet.","color":"#3b82f6","path":[[59.4639,10.9807],[59.4628,10.9821],[59.4621,10.9837],[59.4629,10.9849],[59.4642,10.9841],[59.4650,10.9825],[59.4644,10.9813],[59.4639,10.9807]]},{"id":"p1757834017123","title":"P: skogsvei","lat":59.46683580391216,"lng":10.97812786711084,"category":"Parkering","desc":"","color":"#0ea5e9","link":"","image":""},{"id":"p1757834049191","title":"P: sør","lat":59.45959069378614,"lng":10.985338140101075,"category":"Parkering","desc":"","color":"#0ea5e9","link":"","image":""},{"id":"p1757834066354","title":"Utsikt","lat":59.46508365762609,"lng":10.984182307768183,"category":"Utsiktspunkt","desc":"","color":"#8b5cf6","link":"","image":""},{"id":"p1757834083346","title":"Badeplass","lat":59.459132238897536,"lng":10.980340515878513,"category":"Badeplass","desc":"","color":"#06b6d4","link":"","image":""},{"id":"p1757834098959","title":"Husmannsplass","lat":59.45990326888591,"lng":10.977278470212452,"category":"Husmannsplass","desc":"","color":"#92400e","link":"","image":""},{"id":"p1757834123472","title":"Kulturminne","lat":59.46134251470004,"lng":10.977703662495633,"category":"Kulturminne","desc":"","color":"#b91c1c","link":"","image":""},{"id":"p1757834142768","title":"Interessepunkt","lat":59.46236530907771,"lng":10.97950258092341,"category":"Interessepunkt","desc":"","color":"#14b8a6","link":"","image":""},{"id":"p1757834158425","title":"Matbutikk","lat":59.45786839979072,"lng":10.986619854430143,"category":"Matbutikk","desc":"","color":"#22c55e","link":"","image":""},{"id":"p1757834175707","title":"Båtslipp","lat":59.45975622842604,"lng":10.99613034287238,"category":"Båtslipp","desc":"","color":"#0284c7","link":"","image":""},{"id":"p1757834194682","title":"Aktivitet","lat":59.4631883775577,"lng":10.991371655751005,"category":"Aktivitet","desc":"","color":"#f97316","link":"","image":""},{"id":"p1757834208620","title":"Bensinstasjon","lat":59.46729004889702,"lng":10.992606438494698,"category":"Bensinstasjon","desc":"","color":"#ef4444","link":"","image":""},{"id":"p1757834230209","title":"Parkering","lat":59.46533542626366,"lng":10.988046617333666,"category":"Parkering","desc":"","color":"#0ea5e9","link":"","image":""},{"id":"p1757834247301","title":"Interessepunkt","lat":59.46574802322956,"lng":10.989748691558085,"category":"Interessepunkt","desc":"","color":"#14b8a6","link":"","image":""},{"id":"p1757834261932","title":"Utsiktspunkt","lat":59.466079271532166,"lng":10.993743735841125,"category":"Utsiktspunkt","desc":"","color":"#8b5cf6","link":"","image":""},{"id":"p1757834277089","title":"Kulturminne","lat":59.46721077498835,"lng":10.9964700281081,"category":"Kulturminne","desc":"","color":"#b91c1c","link":"","image":""},{"id":"p1757834292087","title":"Matbutikk","lat":59.46820987696507,"lng":10.99680573641503,"category":"Matbutikk","desc":"","color":"#22c55e","link":"","image":""},{"id":"p1757834310361","title":"Aktivitet","lat":59.47100491922751,"lng":10.999919884274133,"category":"Aktivitet","desc":"","color":"#f97316","link":"","image":""},{"id":"p1757834326544","title":"Båtslipp","lat":59.471194168092324,"lng":11.00092201733119,"category":"Båtslipp","desc":"","color":"#0284c7","link":"","image":""},{"id":"p1757834341091","title":"Bensinstasjon","lat":59.47120946311194,"lng":11.00512744140625,"category":"Bensinstasjon","desc":"","color":"#ef4444","link":"","image":""},{"id":"p1757834360402","title":"Parkering","lat":59.470654936455534,"lng":11.006636410088745,"category":"Parkering","desc":"","color":"#0ea5e9","link":"","image":""},{"id":"p1757834376902","title":"Utsiktspunkt","lat":59.47019020741891,"lng":11.009178373143593,"category":"Utsiktspunkt","desc":"","color":"#8b5cf6","link":"","image":""},{"id":"p1757834390810","title":"Kulturminne","lat":59.46947644420651,"lng":11.01095050573349,"category":"Kulturminne","desc":"","color":"#b91c1c","link":"","image":""},{"id":"p1757834403901","title":"Matbutikk","lat":59.46884548224654,"lng":11.012892305850983,"category":"Matbutikk","desc":"","color":"#22c55e","link":"","image":""},{"id":"p1757834419689","title":"Aktivitet","lat":59.467812996978664,"lng":11.016377955675125,"category":"Aktivitet","desc":"","color":"#f97316","link":"","image":""},{"id":"p1757834433456","title":"Båtslipp","lat":59.46740281635174,"lng":11.017568200826645,"category":"Båtslipp","desc":"","color":"#0284c7","link":"","image":""}] ;

  // --- konfig ---
  const IMAGE_URL='Turkart.png?v='+Date.now();
  // Hjørner i rekkefølge: NW, NE, SE, SW (WGS84 / lat,lng)
  const CORNERS=[
    [59.54593535667747, 10.765142440795898],
    [59.539561484456776, 11.201162338256838],
    [59.380786150970934, 11.190948486328127],
    [59.387167906588274, 10.756945610046387]
  ];

  // --- Leaflet-basiskart ---
  const map=L.map('map', { zoomControl:true, zoomAnimation:true, fadeAnimation:true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap-bidragsytere'
  }).addTo(map);

  // --- egendefinert canvas-warp layer oppå overlayPane ---
  const warpPane=map.createPane('warp');
  warpPane.classList.add('warp-pane');
  const canvas=document.createElement('canvas');
  const ctx=canvas.getContext('2d');
  warpPane.appendChild(canvas);
  let img=new Image(); let imgW=0, imgH=0; img.onload=()=>{ imgW=img.naturalWidth; imgH=img.naturalHeight; renderWarp(); setStatus('Klar'); }; img.onerror=()=> setStatus('Klarte ikke å laste Turkart.png'); img.src=IMAGE_URL;

  const toPt=(latlng)=> map.latLngToLayerPoint(latlng);
  const CORNERS_LL=CORNERS.map(([lat,lng])=>L.latLng(lat,lng));
  const bounds=L.latLngBounds(CORNERS_LL);
  function fitView(){ map.fitBounds(bounds, { padding:[10,10] }); }
  document.getElementById('fitBtn').onclick=fitView;

  function resizeCanvas(){ const sz=map.getSize(); canvas.width=sz.x; canvas.height=sz.y; const pos=map.containerPointToLayerPoint([0,0]); L.DomUtil.setPosition(canvas, pos); }
  function setTriTransform(ctx,s0,s1,s2,d0,d1,d2){
    const a11=s1.x-s0.x,a12=s2.x-s0.x,a21=s1.y-s0.y,a22=s2.y-s0.y; const det=a11*a22-a12*a21; if(Math.abs(det)<1e-12){ ctx.setTransform(1,0,0,1,0,0); return; }
    const inv11=a22/det, inv12=-a12/det, inv13=-(inv11*s0.x+inv12*s0.y);
    const inv21=-a21/det, inv22=a11/det, inv23=-(inv21*s0.x+inv22*s0.y);
    const b11=d1.x-d0.x, b12=d2.x-d0.x, b13=d0.x;
    const b21=d1.y-d0.y, b22=d2.y-d0.y, b23=d0.y;
    const A=b11*inv11+b12*inv21, B=b21*inv11+b22*inv21;
    const C=b11*inv12+b12*inv22, D=b21*inv12+b22*inv22;
    const E=b11*inv13+b12*inv23+b13, F=b21*inv13+b22*inv23+b23;
    ctx.setTransform(A,B,C,D,E,F);
  }
  const lerp=(a,b,t)=> a+(b-a)*t;
  const lerpPt=(p,q,t)=> ({x:lerp(p.x,q.x,t), y:lerp(p.y,q.y,t)});

  const opacity=document.getElementById('opacity');
  opacity.addEventListener('input', ()=> renderWarp());

  function renderWarp(){ if(!imgW||!imgH) return; resizeCanvas(); ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.globalAlpha=parseFloat(opacity.value||'0.95');
    const [NW,NE,SE,SW]=CORNERS_LL.map(ll=>toPt(ll));
    const COLS=20, ROWS=20; // stabilt og pen kvalitet
    for(let j=0;j<ROWS;j++){
      const v0=j/ROWS, v1=(j+1)/ROWS;
      const L0=lerpPt(NW,SW,v0), R0=lerpPt(NE,SE,v0);
      const L1=lerpPt(NW,SW,v1), R1=lerpPt(NE,SE,v1);
      for(let i=0;i<COLS;i++){
        const u0=i/COLS, u1=(i+1)/COLS;
        const Q00=lerpPt(L0,R0,u0), Q10=lerpPt(L0,R0,u1);
        const Q01=lerpPt(L1,R1,u0), Q11=lerpPt(L1,R1,u1);
        // tri 1: 00-10-11
        ctx.save(); ctx.beginPath(); ctx.moveTo(Q00.x,Q00.y); ctx.lineTo(Q10.x,Q10.y); ctx.lineTo(Q11.x,Q11.y); ctx.closePath(); ctx.clip();
        const S00={x:u0*imgW, y:v0*imgH}, S10={x:u1*imgW, y:v0*imgH}, S11={x:u1*imgW, y:v1*imgH};
        setTriTransform(ctx,S00,S10,S11,Q00,Q10,Q11);
        ctx.drawImage(img,0,0);
        ctx.restore();
        // tri 2: 00-11-01
        ctx.save(); ctx.beginPath(); ctx.moveTo(Q00.x,Q00.y); ctx.lineTo(Q11.x,Q11.y); ctx.lineTo(Q01.x,Q01.y); ctx.closePath(); ctx.clip();
        const S01={x:u0*imgW, y:v1*imgH};
        setTriTransform(ctx,S00,S11,S01,Q00,Q11,Q01);
        ctx.drawImage(img,0,0);
        ctx.restore();
      }
    }
    ctx.restore();
  }

  map.on('move zoom resize', renderWarp);
  // start synlig utsnitt
  fitView();

  // --- GPS med Leaflet ---
  const dropIcon=L.divIcon({ className:'poi-icon', html:`<svg class="gps-drop" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><path d="M14 1 C8 1 4 5.5 4 10.5 c0 6.5 8 13 10 16 2-3 10-9.5 10-16 C24 5.5 20 1 14 1z" fill="#2563eb" stroke="white" stroke-width="2"/><circle cx="14" cy="11" r="4" fill="white"/></svg>` });
  let userMarker=null, accCircle=null, watchId=null;
  function showUser(lat,lng,acc){ const ll=L.latLng(lat,lng); if(!userMarker){ userMarker=L.marker(ll,{icon:dropIcon}).addTo(map); } else userMarker.setLatLng(ll);
    if(!accCircle){ accCircle=L.circle(ll,{ radius:acc||0, className:'gps-acc', color:'#2563eb', weight:1, fillOpacity:0.08 }).addTo(map); }
    accCircle.setLatLng(ll); if(acc!=null) accCircle.setRadius(acc);
  }
  function startPrecise(){ if(!navigator.geolocation){ setStatus('Geolocation ikke støttet'); return; } stopWatch(); setStatus('Sporer (presis)…'); watchId=navigator.geolocation.watchPosition(pos=>{
      showUser(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy);
      setStatus(`Sporer: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)} (±${Math.round(pos.coords.accuracy)} m)`);
    }, err=>{ const code=({1:'PERMISSION_DENIED',2:'POSITION_UNAVAILABLE',3:'TIMEOUT'})[err.code]||'ERROR'; setStatus(`Sporing feilet: ${code} – ${err.message}`); }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 }); }
  function centerMe(){ if(userMarker){ map.panTo(userMarker.getLatLng()); return; } if(!navigator.geolocation){ setStatus('Geolocation ikke støttet'); return; } setStatus('Henter posisjon…'); navigator.geolocation.getCurrentPosition(pos=>{ showUser(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy); map.setView([pos.coords.latitude,pos.coords.longitude], map.getZoom()); setStatus(`Posisjon: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)} (±${Math.round(pos.coords.accuracy)} m)`); }, err=>{ const code=({1:'PERMISSION_DENIED',2:'POSITION_UNAVAILABLE',3:'TIMEOUT'})[err.code]||'ERROR'; setStatus(`Kunne ikke hente posisjon: ${code} – ${err.message}`); }, { enableHighAccuracy:false, timeout:8000, maximumAge:120000 }); }
  function stopWatch(){ if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; setStatus('Sporing stoppet'); } }
  document.getElementById('startPrecise').onclick=startPrecise;
  document.getElementById('centerMe').onclick=centerMe;
  document.getElementById('stopWatch').onclick=stopWatch;

  // --- POI visning (lesevisning, stabil) ---
  const poiToggle=document.getElementById('poiToggle');
  const poiLayer=L.layerGroup().addTo(map);
  const routeLines=new Map();

  function colorForCategory(cat){
    const key=(cat||'').toString().toLowerCase();
    const mapC={ 
      'parkering':'#0ea5e9','badeplass':'#06b6d4','utsiktspunkt':'#8b5cf6','husmannsplass':'#92400e','båtslipp':'#0284c7',
      'matbutikk':'#22c55e','bensinstasjon':'#ef4444','aktivitet':'#f97316','kulturminne':'#b91c1c','interessepunkt':'#14b8a6',
      'turforslag':'#3b82f6','turmål':'#22c55e','': '#6b7280'
    };
    return mapC[key]||'#6b7280';
  }
  function iconHtml(color){
    return `<svg width="24" height="24" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg"><path d="M14 1 C8 1 4 5.5 4 10.5 c0 6.5 8 13 10 16 2-3 10-9.5 10-16 C24 5.5 20 1 14 1z" fill="${color}" stroke="white" stroke-width="2"/><circle cx="14" cy="11" r="3.5" fill="white"/></svg>`;
  }
  function mkIcon(color){ return L.divIcon({ className:'poi-icon', html:iconHtml(color), iconSize:[24,24], iconAnchor:[12,22] }); }

  function buildPOIs(){
    poiLayer.clearLayers();
    for(const p of POIS){
      if(typeof p.lat!=="number"||typeof p.lng!=="number") continue;
      const color=p.color||colorForCategory(p.category);
      const m=L.marker([p.lat,p.lng], { icon: mkIcon(color) }).addTo(poiLayer);
      if(p.title) m.bindTooltip(p.title, { direction:'top', opacity:0.95, offset:[0,-18], className:'mytooltip' });
      const parts=[];
      parts.push(`<h3 style="margin:0 0 6px">${escapeHtml(p.title||'Punkt')}</h3>`);
      if(p.image) parts.push(`<img src="${escapeAttr(p.image)}" style="max-width:240px;border-radius:8px;display:block;margin:6px 0">`);
      if(p.desc) parts.push(`<div style="margin:0 0 8px">${escapeHtml(p.desc)}</div>`);
      parts.push(`<div style="font-size:12px;color:#374151">Kategori: ${escapeHtml(p.category||'—')} · Lat/Lng: ${(p.lat||0).toFixed(5)}, ${(p.lng||0).toFixed(5)}</div>`);
      if(p.link) parts.push(`<div style="margin-top:6px"><a href="${escapeAttr(p.link)}" target="_blank" rel="noopener">Mer info ↗</a></div>`);
      m.bindPopup(parts.join(''));

      if(Array.isArray(p.path) && p.path.length>=2){
        m.on('popupopen', ()=>{
          if(routeLines.has(p.id)) return;
          const latlngs = p.path.map(pt=> Array.isArray(pt)&&pt.length===2 ? L.latLng(pt[0],pt[1]) : null).filter(Boolean);
          const line=L.polyline(latlngs, { color: color, weight:9, opacity:0.5, lineJoin:'round', lineCap:'round' }).addTo(map);
          routeLines.set(p.id, line);
        });
        m.on('popupclose', ()=>{
          const line=routeLines.get(p.id);
          if(line) { map.removeLayer(line); routeLines.delete(p.id); }
        });
      }
    }
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function escapeAttr(s){ return String(s||'').replace(/\"/g,'&quot;'); }

  buildPOIs();

  poiToggle.addEventListener('change', ()=>{
    if(poiToggle.checked) poiLayer.addTo(map); else poiLayer.remove();
  });

})();
</script>
</body>
</html>
