<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>nykart – fri forvrengning (dra alle fire hjørner)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.DistortableImage (fri forvrengning/perspektiv) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.distortableimage@0.12.2/dist/leaflet.distortableimage.css" />
  <script src="https://unpkg.com/leaflet.distortableimage@0.12.2/dist/leaflet.distortableimage.js"></script>

  <style>
    html, body { margin:0; height:100%; }
    #map { height:100vh; width:100%; }

    .panel {
      position:absolute; z-index:1000; top:10px; left:10px;
      background:rgba(255,255,255,.97); padding:10px 12px; border-radius:10px;
      box-shadow:0 8px 24px rgba(0,0,0,.14);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      display:grid; gap:8px; max-width:720px;
    }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button { padding:6px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    .small { font-size:12px; color:#444; }
    .mono { font:12px/1.35 ui-monospace,Consolas,Menlo,monospace; white-space:break-spaces; }
    .kbd { padding:1px 6px; border:1px solid #ddd; border-radius:6px; background:#f8f8f9; font:12px ui-monospace; }
  </style>
</head>
<body>
  <div class="panel">
    <div class="row">
      <strong>Dra alle fire hjørnene (fri forvrengning)</strong>
      <span class="small">Fil: <b>Turkart.png</b>. Hjørne-håndtak vises når du klikker på bildet.</span>
    </div>
    <div class="row">
      <button id="fitBtn">Vis hele bildet</button>
      <button id="resetBtn">Tilbakestill fra world-fil</button>
      <button id="copyBtn">Kopier hjørner (WGS84)</button>
    </div>
    <div class="small">Tips: bruk mus og zoom inn for presis plassering. Tast <span class="kbd">Esc</span> for å avslutte aktiv redigering.</div>
    <div id="status" class="small">Laster…</div>
    <div id="out" class="mono small"></div>
  </div>

  <div id="map"></div>

  <script>
    // ---- Konfig ----
    const IMAGE_URL = "Turkart.png";
    const WORLD_CANDIDATES = ["Turkart.pgw","Turkart.tfw","Turkart.jgw"]; // valgfritt; brukes til startplassering

    // ---- Hjelpere ----
    const $ = id => document.getElementById(id);
    const status = msg => $('status').textContent = msg;

    // UTM32 -> WGS84 (ETRS89) for world-init
    function utmToLatLon(E, N, zone=32, northern=true){
      const a=6378137.0, f=1/298.257222101, b=a*(1-f);
      const e2=(a*a-b*b)/(a*a), ep2=(a*a-b*b)/(b*b), k0=0.9996;
      const lon0=((zone-1)*6-180+3)*Math.PI/180;
      const x=E-500000.0, y=northern?N:N-10000000.0;
      const M=y/k0, mu=M/(a*(1-e2/4-3*e2**2/64-5*e2**3/256));
      const e1=(1-Math.sqrt(1-e2))/(1+Math.sqrt(1-e2));
      const J1=3*e1/2-27*e1**3/32, J2=21*e1**2/16-55*e1**4/32, J3=151*e1**3/96, J4=1097*e1**4/512;
      const fp=mu+J1*Math.sin(2*mu)+J2*Math.sin(4*mu)+J3*Math.sin(6*mu)+J4*Math.sin(8*mu);
      const C1=ep2*Math.cos(fp)**2, T1=Math.tan(fp)**2;
      const N1=a/Math.sqrt(1-e2*Math.sin(fp)**2), R1=N1*(1-e2)/(1-e2*Math.sin(fp)**2);
      const D=x/(N1*k0);
      const lat=fp-(N1*Math.tan(fp)/R1)*((D**2)/2-(5+3*T1+10*C1-4*C1**2-9*ep2)*(D**4)/24+(61+90*T1+298*C1+45*T1**2-252*ep2-3*C1**2)*(D**6)/720);
      const lon=lon0+(D-(1+2*T1+C1)*(D**3)/6+(5-2*C1+28*T1-3*C1**2+8*ep2+24*T1**2)*(D**5)/120)/Math.cos(fp);
      return [lat*180/Math.PI, lon*180/Math.PI];
    }

    async function loadWorld(){
      for(const name of WORLD_CANDIDATES){
        try{
          const r = await fetch(name, {cache:'no-store'});
          if(r.ok){
            const t = await r.text();
            const L = t.trim().split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
            if(L.length>=6){
              const A=+L[0], D=+L[1], B=+L[2], E=+L[3], C=+L[4], F=+L[5];
              // rektangel-corners fra world: NW, NE, SE, SW
              const west  = C - A/2.0;
              const north = F - E/2.0;     // E<0
              const img = await loadImage(IMAGE_URL);
              const east  = west  + A*img.naturalWidth;
              const south = north + E*img.naturalHeight; // E<0 -> south < north
              const [nwLat, nwLng] = utmToLatLon(west, north);
              const [neLat, neLng] = utmToLatLon(east, north);
              const [seLat, seLng] = utmToLatLon(east, south);
              const [swLat, swLng] = utmToLatLon(west, south);
              return { ok:true, corners:[[nwLat,nwLng],[neLat,neLng],[seLat,seLng],[swLat,swLng]], name };
            }
          }
        }catch{}
      }
      return { ok:false, msg:"Fant ingen world-fil – starter midlertidig i Norge." };
    }

    function toLatLngs(corners){
      // [ [lat,lng], ... ] -> [L.latLng(), ...]
      return corners.map(([lat,lng]) => L.latLng(lat,lng));
    }

    function getCornersWGS(overlay){
      // rekkefølge: NW, NE, SE, SW (Leaflet.DistortableImage)
      const c = overlay.getCorners(); // returns array of LatLngs
      return {
        NW: [c[0].lat, c[0].lng],
        NE: [c[1].lat, c[1].lng],
        SE: [c[2].lat, c[2].lng],
        SW: [c[3].lat, c[3].lng],
      };
    }

    function cornersText(obj){
      return `NW: [${obj.NW[0]}, ${obj.NW[1]}]
NE: [${obj.NE[0]}, ${obj.NE[1]}]
SE: [${obj.SE[0]}, ${obj.SE[1]}]
SW: [${obj.SW[0]}, ${obj.SW[1]}]`;
    }

    function loadImage(url){
      return new Promise((res, rej)=>{
        const im = new Image();
        im.onload = ()=> res(im);
        im.onerror = ()=> rej(new Error("Kunne ikke laste " + url));
        im.src = url + "?v=" + Date.now();
      });
    }

    let map, overlay;

    (async function init(){
      // 1) Kart
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap-bidragsytere'}).addTo(map);

      // 2) Startcorners: world hvis mulig, ellers et grovt utsnitt
      let startCorners;
      const w = await loadWorld();
      if (w.ok){
        startCorners = toLatLngs(w.corners);
        status(`Startet med georeferanse fra ${w.name}. Klikk bildet for å vise håndtak, og dra hjørnene.`);
      } else {
        startCorners = [
          L.latLng(59.55, 10.70),
          L.latLng(59.55, 10.90),
          L.latLng(59.45, 10.90),
          L.latLng(59.45, 10.70)
        ];
        status(w.msg + " Dra hjørnene til riktig posisjon.");
      }

      // 3) Fri forvrengning – legg til bildet
      overlay = new L.DistortableImageOverlay(IMAGE_URL, {
        corners: startCorners,         // rekkefølge: NW, NE, SE, SW
        editable: true,
        mode: 'distort',               // fri forvrengning
        suppressToolbar: false,        // vis liten verktøylinje
        actions: ['lock', 'unlock', 'rotate', 'scale', 'distort', 'opacity', 'remove']
      }).addTo(map);

      overlay.once('load', () => map.fitBounds(L.latLngBounds(startCorners)));

      // 4) UI-knapper
      $('fitBtn').onclick = () => map.fitBounds(overlay.getBounds(), {padding:[10,10]});

      $('resetBtn').onclick = async () => {
        const w2 = await loadWorld();
        if (w2.ok){
          overlay.setCorners(toLatLngs(w2.corners));
          map.fitBounds(L.latLngBounds(toLatLngs(w2.corners)), {padding:[10,10]});
          status(`Tilbakestilt fra ${w2.name}.`);
        } else {
          status("Fant ingen world-fil å tilbakestille fra.");
        }
      };

      $('copyBtn').onclick = () => {
        const c = getCornersWGS(overlay);
        const txt = cornersText(c);
        $('out').textContent = txt;
        navigator.clipboard?.writeText(txt).then(()=>{ status("Hjørner kopiert til utklippstavla."); }).catch(()=>{});
      };

    })().catch(err => { status(err.message); console.error(err); });
  </script>
</body>
</html>
